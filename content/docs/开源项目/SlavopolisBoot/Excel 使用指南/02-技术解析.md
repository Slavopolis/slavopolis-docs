# æŠ€æœ¯è§£æ

æœ¬æ–‡æ¡£æ·±å…¥å‰–æ `slavopolis-excel` æ¨¡å—çš„æŠ€æœ¯æ¶æ„è®¾è®¡ï¼Œæ¶‰åŠè®¾è®¡åŸç†ã€æ¶æ„æ¨¡å¼ã€æ ¸å¿ƒç®—æ³•åˆ°å®ç°ç»†èŠ‚ï¼Œä¸ºå¸Œæœ›æ·±åº¦ç†è§£è¯¥æ¡†æ¶çš„å¼€å‘è€…æä¾›å…¨é¢çš„æŠ€æœ¯æŒ‡å¯¼ã€‚

---

## ç›®å½•

1. [æ•´ä½“æ¶æ„è®¾è®¡](#1-æ•´ä½“æ¶æ„è®¾è®¡)
2. [æ ¸å¿ƒè®¾è®¡æ¨¡å¼](#2-æ ¸å¿ƒè®¾è®¡æ¨¡å¼)
3. [åˆ†å±‚æ¶æ„åˆ†æ](#3-åˆ†å±‚æ¶æ„åˆ†æ)
4. [æ•°æ®æµä¸æ§åˆ¶æµ](#4-æ•°æ®æµä¸æ§åˆ¶æµ)
5. [æ³¨è§£å¤„ç†æœºåˆ¶](#5-æ³¨è§£å¤„ç†æœºåˆ¶)
6. [è½¬æ¢å™¨æ¶æ„](#6-è½¬æ¢å™¨æ¶æ„)
7. [å¼‚å¸¸å¤„ç†ä½“ç³»](#7-å¼‚å¸¸å¤„ç†ä½“ç³»)
8. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#8-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
9. [æ‰©å±•æœºåˆ¶è®¾è®¡](#9-æ‰©å±•æœºåˆ¶è®¾è®¡)
10. [Springé›†æˆåŸç†](#10-springé›†æˆåŸç†)

---

## 1. æ•´ä½“æ¶æ„è®¾è®¡

### 1.1 æ¶æ„æ¦‚è§ˆ

slavopolis-excel é‡‡ç”¨**å¤šå±‚æ¬¡ã€å¯æ’æ‹”ã€æ³¨è§£é©±åŠ¨**çš„æ¶æ„è®¾è®¡ï¼ŒåŸºäº EasyExcel è¿›è¡Œæ·±å°è£…ï¼Œæä¾› Excel å¤„ç†èƒ½åŠ›ã€‚

```mermaid
graph TB
    subgraph "åº”ç”¨å±‚ (Application Layer)"
        A1[AnnotationExcelService]
        A2[Controller/Service]
        A3[ä¸šåŠ¡é€»è¾‘]
    end
    
    subgraph "æœåŠ¡å±‚ (Service Layer)"
        S1[ExcelServiceæ¥å£]
        S2[ExcelServiceImpl]
        S3[ExcelReaderService]
        S4[ExcelWriterService]
        S5[ExcelFillerService]
    end
    
    subgraph "å¤„ç†å±‚ (Processing Layer)"
        P1[AnnotationProcessor]
        P2[DataProcessor]
        P3[ConverterManager]
        P4[ErrorCollector]
    end
    
    subgraph "æ¨¡å‹å±‚ (Model Layer)"
        M1[Request Models]
        M2[Response Models]
        M3[Metadata Models]
        M4[Configuration Models]
    end
    
    subgraph "åŸºç¡€è®¾æ–½å±‚ (Infrastructure Layer)"
        I1[EasyExcel Core]
        I2[Spring Framework]
        I3[Java Reflection]
        I4[Concurrent Utils]
    end
    
    A1 --> S1
    A2 --> A1
    A3 --> A2
    
    S1 --> S2
    S2 --> S3
    S2 --> S4
    S2 --> S5
    
    S3 --> P1
    S3 --> P2
    S4 --> P3
    S5 --> P4
    
    P1 --> M3
    P2 --> M1
    P3 --> M2
    P4 --> M4
    
    S3 --> I1
    S4 --> I1
    S5 --> I1
    P1 --> I3
    S2 --> I2
    P2 --> I4
```

### 1.2 æ¶æ„åŸåˆ™

#### 1.2.1 è®¾è®¡åŸåˆ™
- **å•ä¸€èŒè´£åŸåˆ™ (SRP)**: æ¯ä¸ªç±»åªè´Ÿè´£ä¸€ä¸ªç‰¹å®šåŠŸèƒ½
- **å¼€é—­åŸåˆ™ (OCP)**: å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å°é—­
- **ä¾èµ–å€’ç½®åŸåˆ™ (DIP)**: ä¾èµ–æŠ½è±¡è€Œéå…·ä½“å®ç°
- **æ¥å£éš”ç¦»åŸåˆ™ (ISP)**: ç»†ç²’åº¦çš„æ¥å£è®¾è®¡
- **é‡Œæ°æ›¿æ¢åŸåˆ™ (LSP)**: å­ç±»å¯ä»¥æ›¿æ¢çˆ¶ç±»

#### 1.2.2 æ¶æ„ç‰¹æ€§
- **é«˜å†…èšä½è€¦åˆ**: æ¨¡å—å†…éƒ¨ç´§å¯†åä½œï¼Œæ¨¡å—é—´æ¾æ•£è€¦åˆ
- **å¯æ‰©å±•æ€§**: æ’ä»¶å¼çš„è½¬æ¢å™¨å’Œå¤„ç†å™¨
- **ç±»å‹å®‰å…¨**: å…¨æ³›å‹è®¾è®¡ï¼Œç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
- **å¼‚æ­¥å‹å¥½**: CompletableFuture æ”¯æŒå¼‚æ­¥å¤„ç†
- **Spring åŸç”Ÿ**: å®Œæ•´çš„ Spring ç”Ÿæ€é›†æˆ

---

## 2. æ ¸å¿ƒè®¾è®¡æ¨¡å¼

### 2.1 ç­–ç•¥æ¨¡å¼ (Strategy Pattern)

ç”¨äºæ•°æ®è½¬æ¢å’Œå¤„ç†ç­–ç•¥çš„åˆ‡æ¢ã€‚

```mermaid
classDiagram
    class DataProcessor~T~ {
        <<interface>>
        +preProcess(data: T, context: ProcessContext) ProcessResult~T~
        +process(data: T, context: ProcessContext) ProcessResult~T~
        +postProcess(data: T, context: ProcessContext) ProcessResult~T~
    }
    
    class DefaultDataProcessor~T~ {
        +preProcess(data: T, context: ProcessContext) ProcessResult~T~
        +process(data: T, context: ProcessContext) ProcessResult~T~
        +postProcess(data: T, context: ProcessContext) ProcessResult~T~
    }
    
    class ValidationDataProcessor~T~ {
        -validator: Validator
        +preProcess(data: T, context: ProcessContext) ProcessResult~T~
        +process(data: T, context: ProcessContext) ProcessResult~T~
        +postProcess(data: T, context: ProcessContext) ProcessResult~T~
    }
    
    class ProcessorContext {
        -processor: DataProcessor
        +setProcessor(processor: DataProcessor)
        +executeProcess(data: T) ProcessResult~T~
    }
    
    DataProcessor <|.. DefaultDataProcessor
    DataProcessor <|.. ValidationDataProcessor
    ProcessorContext --> DataProcessor
```

**è®¾è®¡ä¼˜åŠ¿**:
- è¿è¡Œæ—¶åˆ‡æ¢å¤„ç†ç­–ç•¥
- æ˜“äºæ‰©å±•æ–°çš„å¤„ç†å™¨
- ç¬¦åˆå¼€é—­åŸåˆ™

### 2.2 å»ºé€ è€…æ¨¡å¼ (Builder Pattern)

ç”¨äºå¤æ‚å¯¹è±¡çš„æ„å»ºï¼Œå¦‚è¯·æ±‚å’Œå“åº”å¯¹è±¡ã€‚

```mermaid
classDiagram
    class ExcelReadRequest~T~ {
        -filePath: String
        -inputStream: InputStream
        -dataClass: Class~T~
        -config: ReadConfig
        -processor: DataProcessor~T~
    }
    
    class ExcelReadRequestBuilder~T~ {
        -filePath: String
        -inputStream: InputStream
        -dataClass: Class~T~
        -config: ReadConfig
        -processor: DataProcessor~T~
        +filePath(path: String) ExcelReadRequestBuilder~T~
        +inputStream(stream: InputStream) ExcelReadRequestBuilder~T~
        +dataClass(clazz: Class~T~) ExcelReadRequestBuilder~T~
        +config(config: ReadConfig) ExcelReadRequestBuilder~T~
        +processor(processor: DataProcessor~T~) ExcelReadRequestBuilder~T~
        +build() ExcelReadRequest~T~
    }
    
    ExcelReadRequestBuilder --> ExcelReadRequest : creates
```

### 2.3 å·¥å‚æ¨¡å¼ (Factory Pattern)

ç”¨äºè½¬æ¢å™¨çš„åˆ›å»ºå’Œç®¡ç†ã€‚

```mermaid
classDiagram
    class ConverterFactory {
        <<abstract>>
        +createConverter(type: Class) ExcelDataConverter
    }
    
    class DefaultConverterFactory {
        -converterMap: Map~Class, Class~
        +createConverter(type: Class) ExcelDataConverter
        +registerConverter(type: Class, converterClass: Class)
    }
    
    class ConverterManager {
        -factory: ConverterFactory
        -converterCache: Map~Class, ExcelDataConverter~
        +getConverter(type: Class) ExcelDataConverter
        +registerConverter(type: Class, converter: ExcelDataConverter)
    }
    
    ConverterFactory <|-- DefaultConverterFactory
    ConverterManager --> ConverterFactory
```

### 2.4 è§‚å¯Ÿè€…æ¨¡å¼ (Observer Pattern)

ç”¨äºè¯»å–è¿‡ç¨‹ä¸­çš„äº‹ä»¶é€šçŸ¥å’Œé”™è¯¯æ”¶é›†ã€‚

```mermaid
classDiagram
    class ReadListener~T~ {
        <<interface>>
        +invoke(data: T, context: AnalysisContext)
        +doAfterAllAnalysed(context: AnalysisContext)
        +onException(exception: Exception, context: AnalysisContext)
    }
    
    class DataCollectListener~T~ {
        -dataList: List~T~
        -errorCollector: ExcelErrorCollector
        -progressCallback: Consumer~Integer~
        +invoke(data: T, context: AnalysisContext)
        +doAfterAllAnalysed(context: AnalysisContext)
        +onException(exception: Exception, context: AnalysisContext)
    }
    
    class StreamDataListener~T~ {
        -dataProcessor: DataProcessor~T~
        -batchSize: int
        +invoke(data: T, context: AnalysisContext)
        +doAfterAllAnalysed(context: AnalysisContext)
    }
    
    ReadListener <|.. DataCollectListener
    ReadListener <|.. StreamDataListener
```

### 2.5 é€‚é…å™¨æ¨¡å¼ (Adapter Pattern)

ç”¨äº EasyExcel åŸç”Ÿ API çš„é€‚é…ã€‚

```mermaid
classDiagram
    class EasyExcelReader {
        +read(filePath: String, listener: ReadListener)
        +read(inputStream: InputStream, listener: ReadListener)
    }
    
    class ExcelReaderAdapter {
        -easyExcelReader: EasyExcelReader
        +read(request: ExcelReadRequest) ExcelReadResult
        +readAsync(request: ExcelReadRequest) CompletableFuture
        -adaptListener(processor: DataProcessor) ReadListener
    }
    
    class ExcelReaderService {
        -adapter: ExcelReaderAdapter
        +read(request: ExcelReadRequest) ExcelReadResult
        +readAsync(request: ExcelReadRequest) CompletableFuture
    }
    
    ExcelReaderAdapter --> EasyExcelReader
    ExcelReaderService --> ExcelReaderAdapter
```

---

## 3. åˆ†å±‚æ¶æ„åˆ†æ

### 3.1 æ¶æ„åˆ†å±‚

```mermaid
graph TB
    subgraph "L1: è¡¨ç¤ºå±‚ (Presentation Layer)"
        direction TB
        L1A[REST Controller]
        L1B[Web API]
        L1C[Command Line Interface]
    end
    
    subgraph "L2: åº”ç”¨æœåŠ¡å±‚ (Application Service Layer)"
        direction TB
        L2A[AnnotationExcelService]
        L2B[ä¸šåŠ¡ç¼–æ’é€»è¾‘]
        L2C[å‚æ•°éªŒè¯]
    end
    
    subgraph "L3: é¢†åŸŸæœåŠ¡å±‚ (Domain Service Layer)"
        direction TB
        L3A[ExcelService Interface]
        L3B[ExcelServiceImpl]
        L3C[ä¸šåŠ¡è§„åˆ™å®ç°]
    end
    
    subgraph "L4: åŸºç¡€æœåŠ¡å±‚ (Infrastructure Service Layer)"
        direction TB
        L4A[ExcelReaderService]
        L4B[ExcelWriterService]
        L4C[ExcelFillerService]
    end
    
    subgraph "L5: ç»„ä»¶å±‚ (Component Layer)"
        direction TB
        L5A[AnnotationProcessor]
        L5B[ConverterManager]
        L5C[ErrorCollector]
    end
    
    subgraph "L6: åŸºç¡€è®¾æ–½å±‚ (Infrastructure Layer)"
        direction TB
        L6A[EasyExcel]
        L6B[Spring Framework]
        L6C[Java Standard Library]
    end
    
    L1A --> L2A
    L1B --> L2A
    L1C --> L2A
    
    L2A --> L3A
    L2B --> L3A
    L2C --> L3A
    
    L3A --> L4A
    L3B --> L4B
    L3C --> L4C
    
    L4A --> L5A
    L4B --> L5B
    L4C --> L5C
    
    L5A --> L6A
    L5B --> L6B
    L5C --> L6C
```

### 3.2 èŒè´£åˆ’åˆ†

| å±‚çº§           | èŒè´£                         | å…³é”®ç»„ä»¶                        |
| -------------- | ---------------------------- | ------------------------------- |
| **è¡¨ç¤ºå±‚**     | æ¥æ”¶è¯·æ±‚ï¼Œå‚æ•°æ ¡éªŒï¼Œç»“æœè½¬æ¢ | Controller, API Gateway         |
| **åº”ç”¨æœåŠ¡å±‚** | ä¸šåŠ¡æµç¨‹ç¼–æ’ï¼Œäº‹åŠ¡ç®¡ç†       | AnnotationExcelService          |
| **é¢†åŸŸæœåŠ¡å±‚** | æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œé¢†åŸŸè§„åˆ™       | ExcelService, ExcelServiceImpl  |
| **åŸºç¡€æœåŠ¡å±‚** | å…·ä½“åŠŸèƒ½å®ç°ï¼ŒæŠ€æœ¯ç»†èŠ‚       | Reader/Writer/Filler Service    |
| **ç»„ä»¶å±‚**     | å·¥å…·ç»„ä»¶ï¼Œé€šç”¨åŠŸèƒ½           | Processor, Converter, Collector |
| **åŸºç¡€è®¾æ–½å±‚** | ç¬¬ä¸‰æ–¹åº“ï¼Œç³»ç»Ÿèµ„æº           | EasyExcel, Spring, JDK          |

---

## 4. æ•°æ®æµä¸æ§åˆ¶æµ

### 4.1 è¯»å–æ“ä½œæ•°æ®æµ

```mermaid
sequenceDiagram
    participant Client
    participant AnnotationExcelService
    participant ExcelServiceImpl
    participant ExcelReaderService
    participant AnnotationProcessor
    participant DataCollectListener
    participant EasyExcel
    participant ErrorCollector

    Client->>AnnotationExcelService: read(filePath, clazz)
    AnnotationExcelService->>AnnotationProcessor: parseSheetMeta(clazz)
    AnnotationProcessor-->>AnnotationExcelService: ExcelSheetMeta
    
    AnnotationExcelService->>AnnotationExcelService: buildReadRequest(meta)
    AnnotationExcelService->>ExcelServiceImpl: read(request)
    ExcelServiceImpl->>ExcelReaderService: read(request)
    
    ExcelReaderService->>DataCollectListener: new DataCollectListener
    ExcelReaderService->>EasyExcel: read(filePath, listener)
    
    loop æ¯è¡Œæ•°æ®
        EasyExcel->>DataCollectListener: invoke(data, context)
        DataCollectListener->>DataCollectListener: validateData(data)
        alt éªŒè¯å¤±è´¥
            DataCollectListener->>ErrorCollector: addError(error)
        else éªŒè¯æˆåŠŸ
            DataCollectListener->>DataCollectListener: addToList(data)
        end
    end
    
    EasyExcel->>DataCollectListener: doAfterAllAnalysed(context)
    DataCollectListener-->>ExcelReaderService: å¤„ç†å®Œæˆ
    ExcelReaderService-->>ExcelServiceImpl: ExcelReadResult
    ExcelServiceImpl-->>AnnotationExcelService: ExcelReadResult
    AnnotationExcelService-->>Client: ExcelReadResult
```

### 4.2 å†™å…¥æ“ä½œæ•°æ®æµ

```mermaid
sequenceDiagram
    participant Client
    participant AnnotationExcelService
    participant ExcelServiceImpl
    participant ExcelWriterService
    participant AnnotationProcessor
    participant DataProcessor
    participant EasyExcel

    Client->>AnnotationExcelService: write(filePath, data, clazz)
    AnnotationExcelService->>AnnotationProcessor: parseSheetMeta(clazz)
    AnnotationProcessor-->>AnnotationExcelService: ExcelSheetMeta
    
    AnnotationExcelService->>AnnotationExcelService: buildWriteRequest(meta, data)
    AnnotationExcelService->>ExcelServiceImpl: write(request)
    ExcelServiceImpl->>ExcelWriterService: write(request)
    
    ExcelWriterService->>DataProcessor: preProcess(data)
    DataProcessor-->>ExcelWriterService: ProcessResult
    
    ExcelWriterService->>ExcelWriterService: configureEasyExcel(metadata)
    ExcelWriterService->>EasyExcel: write(filePath, data)
    
    loop æ‰¹æ¬¡å†™å…¥
        EasyExcel->>EasyExcel: writeData(batch)
    end
    
    EasyExcel-->>ExcelWriterService: å†™å…¥å®Œæˆ
    ExcelWriterService->>DataProcessor: postProcess(result)
    DataProcessor-->>ExcelWriterService: ProcessResult
    
    ExcelWriterService-->>ExcelServiceImpl: ExcelWriteResult
    ExcelServiceImpl-->>AnnotationExcelService: ExcelWriteResult
    AnnotationExcelService-->>Client: ExcelWriteResult
```

### 4.3 æ³¨è§£å¤„ç†æµç¨‹

```mermaid
flowchart TD
    A[æ¥æ”¶Classå¯¹è±¡] --> B{æ£€æŸ¥æ³¨è§£ç¼“å­˜}
    B -->|å‘½ä¸­| C[è¿”å›ç¼“å­˜çš„å…ƒæ•°æ®]
    B -->|æœªå‘½ä¸­| D[å¼€å§‹æ³¨è§£è§£æ]
    
    D --> E{æ˜¯å¦æœ‰@ExcelSheet}
    E -->|æ˜¯| F[è§£æSheetæ³¨è§£]
    E -->|å¦| G[ä½¿ç”¨é»˜è®¤é…ç½®]
    
    F --> H[è§£æå­—æ®µæ³¨è§£]
    G --> H
    
    H --> I[è·å–æ‰€æœ‰å­—æ®µ]
    I --> J[éå†å­—æ®µ]
    
    J --> K{æ˜¯å¦æœ‰@ExcelField}
    K -->|æ˜¯| L[è§£æå­—æ®µæ³¨è§£]
    K -->|å¦| M[è·³è¿‡å­—æ®µ]
    
    L --> N[æ„å»ºExcelFieldMeta]
    M --> O{è¿˜æœ‰å­—æ®µ?}
    N --> O
    
    O -->|æ˜¯| J
    O -->|å¦| P[æŒ‰orderæ’åºå­—æ®µ]
    
    P --> Q[æ„å»ºExcelSheetMeta]
    Q --> R[å­˜å…¥ç¼“å­˜]
    R --> S[è¿”å›å…ƒæ•°æ®]
    
    C --> S
    S --> T[ç»“æŸ]
```

---

## 5. æ³¨è§£å¤„ç†æœºåˆ¶

### 5.1 æ³¨è§£ç³»ç»Ÿæ¶æ„

```mermaid
classDiagram
    class ExcelField {
        <<annotation>>
        +value() String
        +index() int
        +required() boolean
        +converter() Class
        +pattern() String
        +order() int
    }
    
    class ExcelSheet {
        <<annotation>>
        +value() String
        +index() int
        +headerIndex() int
        +dataStartIndex() int
        +enableValidation() boolean
    }
    
    class ExcelTemplate {
        <<annotation>>
        +value() String
        +name() String
        +horizontal() boolean
        +startRow() int
        +cacheSeconds() int
    }
    
    class AnnotationProcessor {
        -sheetMetaCache: Map~Class, ExcelSheetMeta~
        -templateMetaCache: Map~Class, ExcelTemplateMeta~
        +parseSheetMeta(clazz: Class) ExcelSheetMeta
        +parseTemplateMeta(clazz: Class) ExcelTemplateMeta
        +getExcelFields(clazz: Class) List~ExcelFieldMeta~
    }
    
    class ExcelFieldMeta {
        -field: Field
        -fieldName: String
        -columnTitle: String
        -required: boolean
        -converterClass: Class
        +hasValidation() boolean
        +hasCustomConverter() boolean
    }
    
    class ExcelSheetMeta {
        -entityClass: Class
        -sheetName: String
        -fields: List~ExcelFieldMeta~
        +getFieldByName(name: String) ExcelFieldMeta
        +getRequiredFields() List~ExcelFieldMeta~
    }
    
    AnnotationProcessor --> ExcelField : è§£æ
    AnnotationProcessor --> ExcelSheet : è§£æ
    AnnotationProcessor --> ExcelTemplate : è§£æ
    AnnotationProcessor --> ExcelFieldMeta : åˆ›å»º
    AnnotationProcessor --> ExcelSheetMeta : åˆ›å»º
```

### 5.2 æ³¨è§£è§£æç®—æ³•

```mermaid
graph TD
    A[å¼€å§‹è§£æ] --> B[è·å–ç±»ä¸Šçš„æ³¨è§£]
    B --> C{æ˜¯å¦æœ‰@ExcelSheet?}
    C -->|æ˜¯| D[æå–Sheeté…ç½®]
    C -->|å¦| E[ä½¿ç”¨é»˜è®¤Sheeté…ç½®]
    
    D --> F[è·å–æ‰€æœ‰å£°æ˜å­—æ®µ]
    E --> F
    
    F --> G[éå†å­—æ®µ]
    G --> H{å­—æ®µæœ‰@ExcelField?}
    H -->|æ˜¯| I[è§£æå­—æ®µæ³¨è§£]
    H -->|å¦| J[è·³è¿‡å­—æ®µ]
    
    I --> K[åˆ›å»ºExcelFieldMeta]
    K --> L[æ·»åŠ åˆ°å­—æ®µåˆ—è¡¨]
    L --> M{è¿˜æœ‰å­—æ®µ?}
    J --> M
    
    M -->|æ˜¯| G
    M -->|å¦| N[å­—æ®µåˆ—è¡¨æ’åº]
    
    N --> O[æ„å»ºExcelSheetMeta]
    O --> P[å­˜å…¥ç¼“å­˜]
    P --> Q[è¿”å›ç»“æœ]
```

### 5.3 ç¼“å­˜æœºåˆ¶

```mermaid
classDiagram
    class MetadataCache {
        <<interface>>
        +get(key: Class) T
        +put(key: Class, value: T)
        +clear()
        +size() int
    }
    
    class ConcurrentMetadataCache~T~ {
        -cache: ConcurrentHashMap~Class, T~
        -maxSize: int
        -accessOrder: boolean
        +get(key: Class) T
        +put(key: Class, value: T)
        +evictIfNecessary()
    }
    
    class CacheStatistics {
        -hitCount: AtomicLong
        -missCount: AtomicLong
        -evictionCount: AtomicLong
        +recordHit()
        +recordMiss()
        +getHitRate() double
    }
    
    MetadataCache <|.. ConcurrentMetadataCache
    ConcurrentMetadataCache --> CacheStatistics
```

---

## 6. è½¬æ¢å™¨æ¶æ„

### 6.1 è½¬æ¢å™¨è®¾è®¡

```mermaid
classDiagram
    class ExcelDataConverter~T~ {
        <<interface>>
        +convertToJavaData(cellValue: String, contentProperty: ExcelContentProperty, globalConfiguration: GlobalConfiguration) T
        +convertToExcelData(value: T, contentProperty: ExcelContentProperty, globalConfiguration: GlobalConfiguration) String
        +preProcess(value: T, context: ConvertContext) T
        +postProcess(value: T, context: ConvertContext) T
        +supportJavaTypeKey() Class~T~
    }
    
    class LocalDateTimeConverter {
        -formatters: List~DateTimeFormatter~
        -defaultFormat: String
        +convertToJavaData(cellValue: String, ...) LocalDateTime
        +convertToExcelData(value: LocalDateTime, ...) String
        -parseWithMultipleFormats(value: String) LocalDateTime
        -cleanDateString(value: String) String
    }
    
    class BigDecimalConverter {
        -numberFormat: DecimalFormat
        +convertToJavaData(cellValue: String, ...) BigDecimal
        +convertToExcelData(value: BigDecimal, ...) String
        +setNumberFormat(format: String)
    }
    
    class ConverterManager {
        -converterMap: Map~Class, ExcelDataConverter~
        -defaultConverters: Map~Class, Class~
        +registerConverter(type: Class, converter: ExcelDataConverter)
        +getConverter(type: Class) ExcelDataConverter
        +removeConverter(type: Class)
        +configureEasyExcel(builder: ExcelWriterBuilder)
    }
    
    ExcelDataConverter <|.. LocalDateTimeConverter
    ExcelDataConverter <|.. BigDecimalConverter
    ConverterManager --> ExcelDataConverter
```

### 6.2 è½¬æ¢å™¨ç”Ÿå‘½å‘¨æœŸ

```mermaid
stateDiagram-v2
    [*] --> Created : å®ä¾‹åŒ–
    Created --> Registered : æ³¨å†Œåˆ°ç®¡ç†å™¨
    Registered --> Configured : é…ç½®å‚æ•°
    Configured --> Active : æ¿€æ´»ä½¿ç”¨
    
    Active --> Converting : æ‰§è¡Œè½¬æ¢
    Converting --> PreProcessing : é¢„å¤„ç†
    PreProcessing --> MainProcessing : ä¸»è¦è½¬æ¢
    MainProcessing --> PostProcessing : åå¤„ç†
    PostProcessing --> Active : è½¬æ¢å®Œæˆ
    
    Active --> Inactive : åœç”¨
    Inactive --> Active : é‡æ–°æ¿€æ´»
    Inactive --> [*] : é”€æ¯
```

### 6.3 è½¬æ¢å™¨æ³¨å†Œæœºåˆ¶

```mermaid
sequenceDiagram
    participant Client
    participant ConverterManager
    participant ConverterRegistry
    participant EasyExcelBuilder
    participant ConverterInstance

    Client->>ConverterManager: registerConverter(type, converter)
    ConverterManager->>ConverterRegistry: put(type, converter)
    ConverterRegistry-->>ConverterManager: æ³¨å†ŒæˆåŠŸ
    
    Client->>ConverterManager: configureEasyExcel(builder)
    ConverterManager->>ConverterRegistry: getAllConverters()
    ConverterRegistry-->>ConverterManager: Map<Class, Converter>
    
    loop éå†æ‰€æœ‰è½¬æ¢å™¨
        ConverterManager->>EasyExcelBuilder: registerConverter(converter)
        EasyExcelBuilder->>ConverterInstance: é…ç½®è½¬æ¢å™¨
    end
    
    ConverterManager-->>Client: é…ç½®å®Œæˆ
```

---

## 7. å¼‚å¸¸å¤„ç†ä½“ç³»

### 7.1 å¼‚å¸¸å±‚æ¬¡ç»“æ„

```mermaid
classDiagram
    class Exception {
        <<Java Standard>>
    }
    
    class RuntimeException {
        <<Java Standard>>
    }
    
    class ExcelException {
        -errorCode: ExcelErrorCode
        -context: Map~String, Object~
        +getErrorCode() ExcelErrorCode
        +getContext() Map~String, Object~
        +addContext(key: String, value: Object)
    }
    
    class ExcelReadException {
        -rowIndex: int
        -columnIndex: int
        -cellValue: String
        +getRowIndex() int
        +getColumnIndex() int
    }
    
    class ExcelWriteException {
        -dataIndex: int
        -fieldName: String
        +getDataIndex() int
        +getFieldName() String
    }
    
    class ExcelValidationException {
        -violations: List~ConstraintViolation~
        +getViolations() List~ConstraintViolation~
    }
    
    Exception <|-- RuntimeException
    RuntimeException <|-- ExcelException
    ExcelException <|-- ExcelReadException
    ExcelException <|-- ExcelWriteException
    ExcelException <|-- ExcelValidationException
```

### 7.2 é”™è¯¯æ”¶é›†æœºåˆ¶

```mermaid
classDiagram
    class ExcelErrorCollector {
        -errors: List~ExcelError~
        -maxErrors: int
        -failFast: boolean
        +addError(error: ExcelError)
        +addError(rowIndex: int, message: String)
        +hasErrors() boolean
        +getErrors() List~ExcelError~
        +throwIfHasErrors()
        +clear()
    }
    
    class ExcelError {
        -rowIndex: int
        -columnIndex: int
        -fieldName: String
        -cellValue: String
        -errorMessage: String
        -errorCode: ExcelErrorCode
        -timestamp: LocalDateTime
    }
    
    class ErrorReporter {
        +generateReport(errors: List~ExcelError~) String
        +exportToExcel(errors: List~ExcelError~, outputPath: String)
        +groupByType(errors: List~ExcelError~) Map~ExcelErrorCode, List~ExcelError~~
    }
    
    ExcelErrorCollector --> ExcelError
    ErrorReporter --> ExcelError
```

### 7.3 å¼‚å¸¸å¤„ç†æµç¨‹

```mermaid
flowchart TD
    A[å¼‚å¸¸å‘ç”Ÿ] --> B{å¼‚å¸¸ç±»å‹åˆ¤æ–­}
    
    B -->|æ•°æ®è½¬æ¢å¼‚å¸¸| C[ExcelReadException]
    B -->|æ•°æ®éªŒè¯å¼‚å¸¸| D[ExcelValidationException]
    B -->|IOå¼‚å¸¸| E[ExcelWriteException]
    B -->|ç³»ç»Ÿå¼‚å¸¸| F[ExcelException]
    
    C --> G[æ”¶é›†é”™è¯¯ä¿¡æ¯]
    D --> G
    E --> G
    F --> G
    
    G --> H[æ·»åŠ åˆ°ErrorCollector]
    H --> I{æ˜¯å¦å¿«é€Ÿå¤±è´¥?}
    
    I -->|æ˜¯| J[ç«‹å³æŠ›å‡ºå¼‚å¸¸]
    I -->|å¦| K[ç»§ç»­å¤„ç†]
    
    K --> L{æ˜¯å¦è¾¾åˆ°æœ€å¤§é”™è¯¯æ•°?}
    L -->|æ˜¯| J
    L -->|å¦| M[è®°å½•æ—¥å¿—]
    
    M --> N[ç»§ç»­æ‰§è¡Œ]
    J --> O[å¼‚å¸¸å¤„ç†]
    N --> P[å¤„ç†å®Œæˆåæ£€æŸ¥]
    P --> Q{æ˜¯å¦æœ‰é”™è¯¯?}
    Q -->|æ˜¯| R[ç”Ÿæˆé”™è¯¯æŠ¥å‘Š]
    Q -->|å¦| S[æ­£å¸¸ç»“æŸ]
    
    R --> T[è¿”å›ç»“æœå¸¦é”™è¯¯]
    O --> U[å¼‚å¸¸å“åº”]
    S --> V[æˆåŠŸå“åº”]
```

---

## 8. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 8.1 å†…å­˜ä¼˜åŒ–

```mermaid
graph TB
    subgraph "å†…å­˜ä¼˜åŒ–ç­–ç•¥"
        A1[å¯¹è±¡æ± åŒ–]
        A2[æ‰¹å¤„ç†]
        A3[æµå¼å¤„ç†]
        A4[æ‡’åŠ è½½]
        A5[ç¼“å­˜ç­–ç•¥]
    end
    
    subgraph "å¯¹è±¡æ± åŒ–"
        B1[è½¬æ¢å™¨å¤ç”¨]
        B2[Builderå¯¹è±¡å¤ç”¨]
        B3[ç¼“å†²åŒºå¤ç”¨]
    end
    
    subgraph "æ‰¹å¤„ç†"
        C1[æ•°æ®åˆ†æ‰¹è¯»å–]
        C2[æ‰¹é‡å†™å…¥]
        C3[æ‰¹é‡éªŒè¯]
    end
    
    subgraph "æµå¼å¤„ç†"
        D1[StreamDataListener]
        D2[å¼‚æ­¥å¤„ç†]
        D3[èƒŒå‹æ§åˆ¶]
    end
    
    A1 --> B1
    A1 --> B2
    A1 --> B3
    
    A2 --> C1
    A2 --> C2
    A2 --> C3
    
    A3 --> D1
    A3 --> D2
    A3 --> D3
```

### 8.2 å¹¶å‘ä¼˜åŒ–

```mermaid
classDiagram
    class ConcurrentProcessor {
        -executor: ThreadPoolExecutor
        -batchSize: int
        -maxConcurrency: int
        +processAsync(data: List~T~) CompletableFuture~ProcessResult~
        +processBatch(batch: List~T~) ProcessResult
    }
    
    class ThreadSafeErrorCollector {
        -errors: ConcurrentLinkedQueue~ExcelError~
        -errorCount: AtomicInteger
        +addError(error: ExcelError)
        +getErrors() List~ExcelError~
        +getErrorCount() int
    }
    
    class AsyncExcelProcessor {
        -readExecutor: ExecutorService
        -writeExecutor: ExecutorService
        -processingExecutor: ExecutorService
        +readAsync(request: ExcelReadRequest) CompletableFuture
        +writeAsync(request: ExcelWriteRequest) CompletableFuture
        +shutdown()
    }
    
    ConcurrentProcessor --> ThreadSafeErrorCollector
    AsyncExcelProcessor --> ConcurrentProcessor
```

### 8.3 ç¼“å­˜ä¼˜åŒ–

```mermaid
graph LR
    subgraph "å¤šçº§ç¼“å­˜æ¶æ„"
        L1[L1: æ³¨è§£å…ƒæ•°æ®ç¼“å­˜]
        L2[L2: è½¬æ¢å™¨ç¼“å­˜]
        L3[L3: æ¨¡æ¿ç¼“å­˜]
        L4[L4: é…ç½®ç¼“å­˜]
    end
    
    subgraph "ç¼“å­˜ç­–ç•¥"
        S1[LRUæ·˜æ±°]
        S2[TTLè¿‡æœŸ]
        S3[å¼±å¼•ç”¨]
        S4[é¢„çƒ­ç­–ç•¥]
    end
    
    subgraph "ç¼“å­˜ç›‘æ§"
        M1[å‘½ä¸­ç‡ç»Ÿè®¡]
        M2[å†…å­˜ä½¿ç”¨ç›‘æ§]
        M3[æ€§èƒ½æŒ‡æ ‡]
    end
    
    L1 --> S1
    L2 --> S2
    L3 --> S3
    L4 --> S4
    
    S1 --> M1
    S2 --> M2
    S3 --> M3
```

---

## 9. æ‰©å±•æœºåˆ¶è®¾è®¡

### 9.1 SPIæœºåˆ¶

```mermaid
classDiagram
    class ExcelServiceProvider {
        <<interface>>
        +getOrder() int
        +supports(request: Object) boolean
        +provide() Object
    }
    
    class ConverterServiceProvider {
        +getOrder() int
        +supports(type: Class) boolean
        +provide() ExcelDataConverter
    }
    
    class ProcessorServiceProvider {
        +getOrder() int
        +supports(dataType: Class) boolean
        +provide() DataProcessor
    }
    
    class ListenerServiceProvider {
        +getOrder() int
        +supports(context: String) boolean
        +provide() ReadListener
    }
    
    class ServiceProviderManager {
        -providers: List~ExcelServiceProvider~
        +loadProviders()
        +getProvider(type: Class) T
        +getProviders(type: Class) List~T~
    }
    
    ExcelServiceProvider <|.. ConverterServiceProvider
    ExcelServiceProvider <|.. ProcessorServiceProvider
    ExcelServiceProvider <|.. ListenerServiceProvider
    ServiceProviderManager --> ExcelServiceProvider
```

### 9.2 æ’ä»¶æ¶æ„

```mermaid
graph TB
    subgraph "æ’ä»¶æ¥å£å±‚"
        I1[ConverterPlugin]
        I2[ProcessorPlugin]
        I3[ValidatorPlugin]
        I4[ListenerPlugin]
    end
    
    subgraph "æ’ä»¶å®ç°å±‚"
        P1[è‡ªå®šä¹‰è½¬æ¢å™¨]
        P2[è‡ªå®šä¹‰å¤„ç†å™¨]
        P3[è‡ªå®šä¹‰éªŒè¯å™¨]
        P4[è‡ªå®šä¹‰ç›‘å¬å™¨]
    end
    
    subgraph "æ’ä»¶ç®¡ç†å±‚"
        M1[PluginManager]
        M2[PluginRegistry]
        M3[PluginLifecycle]
    end
    
    subgraph "æ’ä»¶é…ç½®å±‚"
        C1[PluginConfiguration]
        C2[PluginProperties]
        C3[PluginMetadata]
    end
    
    I1 --> P1
    I2 --> P2
    I3 --> P3
    I4 --> P4
    
    P1 --> M1
    P2 --> M1
    P3 --> M2
    P4 --> M3
    
    M1 --> C1
    M2 --> C2
    M3 --> C3
```

### 9.3 è‡ªå®šä¹‰æ‰©å±•ç¤ºä¾‹

```java
// è‡ªå®šä¹‰è½¬æ¢å™¨æ‰©å±•
@Component
public class CustomDateConverter implements ExcelDataConverter<LocalDate> {
    @Override
    public LocalDate convertToJavaData(String cellValue, 
                                     ExcelContentProperty contentProperty, 
                                     GlobalConfiguration globalConfiguration) {
        // è‡ªå®šä¹‰è½¬æ¢é€»è¾‘
        return LocalDate.parse(cellValue, DateTimeFormatter.ISO_LOCAL_DATE);
    }
    
    @Override
    public String convertToExcelData(LocalDate value, 
                                   ExcelContentProperty contentProperty, 
                                   GlobalConfiguration globalConfiguration) {
        // è‡ªå®šä¹‰è½¬æ¢é€»è¾‘
        return value.format(DateTimeFormatter.ISO_LOCAL_DATE);
    }
}

// è‡ªå®šä¹‰å¤„ç†å™¨æ‰©å±•
@Component
public class CustomDataProcessor<T> implements DataProcessor<T> {
    @Override
    public ProcessResult<T> preProcess(T data, ProcessContext context) {
        // è‡ªå®šä¹‰é¢„å¤„ç†é€»è¾‘
        return ProcessResult.success(data);
    }
    
    @Override
    public ProcessResult<T> process(T data, ProcessContext context) {
        // è‡ªå®šä¹‰å¤„ç†é€»è¾‘
        return ProcessResult.success(data);
    }
    
    @Override
    public ProcessResult<T> postProcess(T data, ProcessContext context) {
        // è‡ªå®šä¹‰åå¤„ç†é€»è¾‘
        return ProcessResult.success(data);
    }
}
```

---

## 10. Spring é›†æˆåŸç†

### 10.1 è‡ªåŠ¨é…ç½®æœºåˆ¶

```mermaid
sequenceDiagram
    participant SpringBoot
    participant AutoConfigurationImportSelector
    participant ExcelAutoConfiguration
    participant BeanFactory
    participant ApplicationContext

    SpringBoot->>AutoConfigurationImportSelector: å¯åŠ¨è‡ªåŠ¨é…ç½®
    AutoConfigurationImportSelector->>AutoConfigurationImportSelector: æ‰«æMETA-INF/spring/
    AutoConfigurationImportSelector-->>SpringBoot: è¿”å›é…ç½®ç±»åˆ—è¡¨
    
    SpringBoot->>ExcelAutoConfiguration: åŠ è½½é…ç½®ç±»
    ExcelAutoConfiguration->>ExcelAutoConfiguration: æ£€æŸ¥@ConditionalOnClass
    ExcelAutoConfiguration->>ExcelAutoConfiguration: æ£€æŸ¥@ConditionalOnProperty
    
    ExcelAutoConfiguration->>BeanFactory: æ³¨å†ŒBeanå®šä¹‰
    BeanFactory->>BeanFactory: è§£æä¾èµ–å…³ç³»
    BeanFactory->>ApplicationContext: åˆ›å»ºBeanå®ä¾‹
    
    ApplicationContext-->>SpringBoot: è‡ªåŠ¨é…ç½®å®Œæˆ
```

### 10.2 Bean ç”Ÿå‘½å‘¨æœŸç®¡ç†

```mermaid
stateDiagram-v2
    [*] --> BeanDefinitionRegistered : @Beanæ³¨è§£æ‰«æ
    BeanDefinitionRegistered --> BeanInstantiating : å®ä¾‹åŒ–å¼€å§‹
    
    BeanInstantiating --> BeanInstantiated : æ„é€ å‡½æ•°è°ƒç”¨
    BeanInstantiated --> PropertiesSet : å±æ€§æ³¨å…¥
    PropertiesSet --> InitializingBean : @PostConstruct
    
    InitializingBean --> BeanReady : åˆå§‹åŒ–å®Œæˆ
    BeanReady --> InUse : ä¸šåŠ¡ä½¿ç”¨
    
    InUse --> PreDestroy : å®¹å™¨å…³é—­
    PreDestroy --> Destroyed : @PreDestroy
    Destroyed --> [*]
```

### 10.3 é…ç½®å±æ€§ç»‘å®š

```mermaid
classDiagram
    class ExcelProperties {
        @ConfigurationProperties("slavopolis.excel")
        -enabled: boolean
        -validation: ValidationProperties
        -async: AsyncProperties
        -performance: PerformanceProperties
        +isEnabled() boolean
        +getValidation() ValidationProperties
    }
    
    class ValidationProperties {
        -maxFileSize: long
        -maxRows: int
        -maxColumns: int
        -allowedExtensions: List~String~
    }
    
    class AsyncProperties {
        -fileSizeThreshold: long
        -threadPool: ThreadPoolProperties
    }
    
    class ThreadPoolProperties {
        -coreSize: int
        -maxSize: int
        -queueCapacity: int
        -keepAlive: int
    }
    
    ExcelProperties --> ValidationProperties
    ExcelProperties --> AsyncProperties
    AsyncProperties --> ThreadPoolProperties
```

### 10.4 æ¡ä»¶è£…é…

```mermaid
flowchart TD
    A[Beanåˆ›å»ºè¯·æ±‚] --> B{@ConditionalOnClassæ£€æŸ¥}
    B -->|EasyExcelå­˜åœ¨| C{@ConditionalOnPropertyæ£€æŸ¥}
    B -->|ä¸å­˜åœ¨| D[è·³è¿‡Beanåˆ›å»º]
    
    C -->|é…ç½®å¯ç”¨| E{@ConditionalOnMissingBeanæ£€æŸ¥}
    C -->|é…ç½®ç¦ç”¨| D
    
    E -->|Beanä¸å­˜åœ¨| F[åˆ›å»ºBean]
    E -->|Beanå·²å­˜åœ¨| G[ä½¿ç”¨ç°æœ‰Bean]
    
    F --> H[æ³¨å…¥ä¾èµ–]
    G --> I[å®Œæˆè£…é…]
    H --> I
    D --> J[è£…é…ç»“æŸ]
    I --> J
```

---

## æ€»ç»“

slavopolis-excel æ¡†æ¶é‡‡ç”¨äº†ç°ä»£åŒ–çš„æ¶æ„è®¾è®¡ç†å¿µï¼Œé€šè¿‡å¤šå±‚æ¬¡åˆ†ç¦»ã€è®¾è®¡æ¨¡å¼åº”ç”¨ã€æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ç­‰æŠ€æœ¯æ‰‹æ®µï¼Œæ„å»ºäº†ä¸€ä¸ªé€šç”¨çš„ Excel å¤„ç†æ¡†æ¶ã€‚å…¶ä¸»è¦æŠ€æœ¯ç‰¹è‰²åŒ…æ‹¬ï¼š

### ğŸ—ï¸ æ¶æ„ä¼˜åŠ¿
- **åˆ†å±‚æ¸…æ™°**: å…­å±‚æ¶æ„ï¼ŒèŒè´£æ˜ç¡®
- **æ¾æ•£è€¦åˆ**: æ¥å£ç¼–ç¨‹ï¼Œä¾èµ–æ³¨å…¥
- **é«˜åº¦æŠ½è±¡**: ç»Ÿä¸€æ¥å£ï¼Œå¤šç§å®ç°
- **æ˜“äºæ‰©å±•**: æ’ä»¶åŒ–è®¾è®¡ï¼ŒSPIæœºåˆ¶

### ğŸ”§ æŠ€æœ¯ç‰¹è‰²
- **æ³¨è§£é©±åŠ¨**: å£°æ˜å¼é…ç½®ï¼Œç®€åŒ–å¼€å‘
- **ç±»å‹å®‰å…¨**: æ³›å‹è®¾è®¡ï¼Œç¼–è¯‘æ—¶æ£€æŸ¥
- **å¼‚æ­¥æ”¯æŒ**: CompletableFutureï¼Œæå‡æ€§èƒ½
- **Springé›†æˆ**: è‡ªåŠ¨é…ç½®ï¼Œæ— ç¼é›†æˆ

### ğŸš€ æ€§èƒ½ä¼˜åŒ–
- **å†…å­˜ä¼˜åŒ–**: å¯¹è±¡æ± åŒ–ï¼Œæµå¼å¤„ç†
- **å¹¶å‘ä¼˜åŒ–**: çº¿ç¨‹å®‰å…¨ï¼Œå¼‚æ­¥å¤„ç†
- **ç¼“å­˜ä¼˜åŒ–**: å¤šçº§ç¼“å­˜ï¼Œæ™ºèƒ½æ·˜æ±°
- **æ‰¹å¤„ç†**: æ‰¹é‡æ“ä½œï¼Œå‡å°‘å¼€é”€

### ğŸ”’ è´¨é‡ä¿è¯
- **å¼‚å¸¸å¤„ç†**: åˆ†å±‚å¼‚å¸¸ï¼Œè¯¦ç»†ä¸Šä¸‹æ–‡
- **é”™è¯¯æ”¶é›†**: ç»Ÿä¸€æ”¶é›†ï¼Œå‹å¥½æŠ¥å‘Š
- **ç›‘æ§æ”¯æŒ**: æ€§èƒ½æŒ‡æ ‡ï¼Œå¥åº·æ£€æŸ¥
- **æµ‹è¯•å‹å¥½**: ä¾èµ–æ³¨å…¥ï¼Œæ˜“äºæµ‹è¯•

è¯¥æ¡†æ¶ä¸º Excel å¤„ç†æä¾›äº†å®Œæ•´ã€é«˜æ•ˆã€å¯æ‰©å±•çš„è§£å†³æ–¹æ¡ˆï¼Œæ˜¯ç°ä»£ Java åº”ç”¨ç¨‹åºçš„ç†æƒ³é€‰æ‹©ã€‚ 
