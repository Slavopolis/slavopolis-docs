# æŠ€æœ¯è§£æ

åœ¨ä¼ä¸šçº§åº”ç”¨å¼€å‘ä¸­ï¼Œé‚®ä»¶æœåŠ¡å¾€å¾€è¢«è§†ä¸ºä¸€ä¸ªç®€å•çš„åŠŸèƒ½æ¨¡å—ï¼Œä½†å®é™…ä¸Šï¼Œä¸€ä¸ªé«˜è´¨é‡çš„é‚®ä»¶æœåŠ¡éœ€è¦è€ƒè™‘æ€§èƒ½ã€å¯é æ€§ã€å¯æ‰©å±•æ€§ã€ç›‘æ§ç­‰å¤šä¸ªç»´åº¦ã€‚Slavopolis Email æ¨¡å—æ­£æ˜¯åŸºäºè¿™äº›ä¼ä¸šçº§éœ€æ±‚è€Œç²¾å¿ƒè®¾è®¡çš„é‚®ä»¶æœåŠ¡è§£å†³æ–¹æ¡ˆã€‚

æœ¬æ–‡å°†æ·±å…¥å‰–æ Slavopolis Email çš„æŠ€æœ¯æ¶æ„ã€è®¾è®¡æ€è·¯å’Œå®ç°ç»†èŠ‚ï¼Œå¸®åŠ©å¼€å‘è€…ç†è§£å…¶èƒŒåçš„æŠ€æœ¯åŸç†ï¼Œå¹¶ä¸ºç±»ä¼¼ç³»ç»Ÿçš„è®¾è®¡æä¾›å‚è€ƒã€‚

## ğŸ¯ è®¾è®¡ç›®æ ‡ä¸åŸåˆ™

### æ ¸å¿ƒè®¾è®¡ç›®æ ‡

**1. å¼€ç®±å³ç”¨çš„ç®€æ´æ€§**

- é›¶é…ç½®å¯åŠ¨ï¼Œè‡ªåŠ¨è£…é…æ‰€æœ‰å¿…è¦ç»„ä»¶
- æä¾›åˆç†çš„é»˜è®¤é…ç½®ï¼Œé™ä½ä½¿ç”¨é—¨æ§›
- ç»Ÿä¸€çš„APIæ¥å£ï¼Œå±è”½åº•å±‚å¤æ‚æ€§

**2. ä¼ä¸šçº§çš„å¯é æ€§**
- å®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œé‡è¯•æœºåˆ¶
- åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„çŠ¶æ€ä¸€è‡´æ€§
- æ•…éšœéš”ç¦»å’Œé™çº§ç­–ç•¥

**3. é«˜æ€§èƒ½çš„å¤„ç†èƒ½åŠ›**
- å¼‚æ­¥éé˜»å¡çš„å‘é€æœºåˆ¶
- æ‰¹é‡å¤„ç†å’Œè¿æ¥æ± ä¼˜åŒ–
- æ™ºèƒ½çš„é™æµå’ŒèƒŒå‹æ§åˆ¶

**4. çµæ´»çš„æ‰©å±•æ€§**
- æ’ä»¶åŒ–çš„æ¨¡æ¿å¼•æ“æ”¯æŒ
- å¯é…ç½®çš„å‘é€ç­–ç•¥
- å¼€æ”¾çš„ç›‘æ§å’Œç»Ÿè®¡æ¥å£

### è®¾è®¡åŸåˆ™

**å•ä¸€èŒè´£åŸåˆ™ï¼ˆSRPï¼‰**
- æ¯ä¸ªç»„ä»¶ä¸“æ³¨äºç‰¹å®šçš„åŠŸèƒ½é¢†åŸŸ
- é‚®ä»¶å‘é€ã€æ¨¡æ¿æ¸²æŸ“ã€çŠ¶æ€ç®¡ç†ç­‰èŒè´£åˆ†ç¦»
- æ¸…æ™°çš„æ¥å£è¾¹ç•Œå’Œä¾èµ–å…³ç³»

**å¼€é—­åŸåˆ™ï¼ˆOCPï¼‰**
- å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å°é—­
- é€šè¿‡ç­–ç•¥æ¨¡å¼æ”¯æŒå¤šç§å‘é€ç­–ç•¥
- é€šè¿‡å·¥å‚æ¨¡å¼æ”¯æŒå¤šç§æ¨¡æ¿å¼•æ“

**ä¾èµ–å€’ç½®åŸåˆ™ï¼ˆDIPï¼‰**
- ä¾èµ–æŠ½è±¡è€Œéå…·ä½“å®ç°
- é€šè¿‡æ¥å£å®šä¹‰æ ¸å¿ƒå¥‘çº¦
- ä¾¿äºå•å…ƒæµ‹è¯•å’Œæ¨¡å—æ›¿æ¢

**æœ€å°æƒŠè®¶åŸåˆ™**
- APIè®¾è®¡ç¬¦åˆå¼€å‘è€…ç›´è§‰
- é…ç½®é¡¹å‘½åæ¸…æ™°æ˜ç¡®
- é”™è¯¯ä¿¡æ¯è¯¦ç»†ä¸”å¯æ“ä½œ

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„å›¾

```mermaid
graph TB
    subgraph "åº”ç”¨å±‚"
        A[ä¸šåŠ¡æœåŠ¡] --> B[EmailServiceæ¥å£]
    end
    
    subgraph "æœåŠ¡å±‚"
        B --> C[EmailServiceImpl]
        C --> D[å¼‚æ­¥æ‰§è¡Œå™¨]
        C --> E[æ‰¹é‡å¤„ç†å™¨]
        C --> F[çŠ¶æ€ç®¡ç†å™¨]
    end
    
    subgraph "æ¨¡æ¿å±‚"
        G[æ¨¡æ¿å¼•æ“æ¥å£] --> H[FreemarkerEngine]
        G --> I[ThymeleafEngine]
        C --> G
    end
    
    subgraph "ä¼ è¾“å±‚"
        C --> J[SMTPå®¢æˆ·ç«¯]
        J --> K[è¿æ¥æ± ç®¡ç†]
        J --> L[é‡è¯•æœºåˆ¶]
    end
    
    subgraph "å­˜å‚¨å±‚"
        F --> M[å†…å­˜ç¼“å­˜]
        F --> N[Redisç¼“å­˜]
        O[é…ç½®ç®¡ç†] --> P[Properties]
    end
    
    subgraph "ç›‘æ§å±‚"
        Q[ç›‘æ§æ”¶é›†å™¨] --> R[æŒ‡æ ‡ç»Ÿè®¡]
        Q --> S[å‘Šè­¦å¤„ç†]
        C --> Q
    end
    
    subgraph "é™æµå±‚"
        T[é™æµç®¡ç†å™¨] --> U[æ»‘åŠ¨çª—å£]
        T --> V[ä»¤ç‰Œæ¡¶]
        C --> T
    end
```

### æ¨¡å—åˆ’åˆ†

**åº”ç”¨å±‚ï¼ˆApplication Layerï¼‰**
- æä¾›ç»Ÿä¸€çš„é‚®ä»¶æœåŠ¡æ¥å£
- å°è£…ä¸šåŠ¡é€»è¾‘ï¼Œå±è”½æŠ€æœ¯ç»†èŠ‚
- æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥è°ƒç”¨æ¨¡å¼

**æœåŠ¡å±‚ï¼ˆService Layerï¼‰**
- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å®ç°
- å¼‚æ­¥ä»»åŠ¡è°ƒåº¦å’Œç®¡ç†
- æ‰¹é‡å¤„ç†ä¼˜åŒ–
- å‘é€çŠ¶æ€ç®¡ç†

**æ¨¡æ¿å±‚ï¼ˆTemplate Layerï¼‰**
- å¤šæ¨¡æ¿å¼•æ“æ”¯æŒï¼ˆFreemarker/Thymeleafï¼‰
- æ¨¡æ¿ç¼“å­˜å’Œé¢„ç¼–è¯‘
- åŠ¨æ€å†…å®¹æ¸²æŸ“

**ä¼ è¾“å±‚ï¼ˆTransport Layerï¼‰**
- SMTPåè®®å®ç°
- è¿æ¥æ± ç®¡ç†
- é‡è¯•å’Œæ•…éšœæ¢å¤

**å­˜å‚¨å±‚ï¼ˆStorage Layerï¼‰**
- å¤šçº§ç¼“å­˜ç­–ç•¥
- é…ç½®ç®¡ç†
- çŠ¶æ€æŒä¹…åŒ–

**ç›‘æ§å±‚ï¼ˆMonitor Layerï¼‰**
- æŒ‡æ ‡æ”¶é›†å’Œç»Ÿè®¡
- æ€§èƒ½ç›‘æ§
- å‘Šè­¦å¤„ç†

**é™æµå±‚ï¼ˆRate Limit Layerï¼‰**
- å¤šç»´åº¦é™æµç­–ç•¥
- åŠ¨æ€é˜ˆå€¼è°ƒæ•´
- èƒŒå‹æ§åˆ¶

## ğŸ”§ æ ¸å¿ƒæŠ€æœ¯å®ç°

### 1. å¼‚æ­¥å‘é€æ¶æ„

#### å¼‚æ­¥æ‰§è¡Œå™¨è®¾è®¡

```java
@Component
public class EmailAsyncExecutor {
    
    private final ThreadPoolTaskExecutor executor;
    private final EmailSendResultCache resultCache;
    
    public EmailAsyncExecutor(EmailProperties properties) {
        this.executor = createExecutor(properties.getSendStrategy());
        this.resultCache = new EmailSendResultCache();
    }
    
    public CompletableFuture<EmailSendResult> executeAsync(EmailMessage message) {
        return CompletableFuture.supplyAsync(() -> {
            try {
                // æ‰§è¡Œå‘é€é€»è¾‘
                EmailSendResult result = doSendEmail(message);
                
                // ç¼“å­˜ç»“æœ
                resultCache.put(message.getMessageId(), result);
                
                return result;
            } catch (Exception e) {
                EmailSendResult errorResult = EmailSendResult.failure(
                    message.getMessageId(), 
                    EmailErrorCode.SEND_FAILED, 
                    e.getMessage()
                );
                resultCache.put(message.getMessageId(), errorResult);
                return errorResult;
            }
        }, executor);
    }
    
    private ThreadPoolTaskExecutor createExecutor(SendStrategy strategy) {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(strategy.getAsyncPoolSize());
        executor.setMaxPoolSize(strategy.getAsyncPoolSize() * 2);
        executor.setQueueCapacity(strategy.getAsyncQueueSize());
        executor.setThreadNamePrefix("email-async-");
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        executor.initialize();
        return executor;
    }
}
```

#### æ‰¹é‡å¤„ç†ä¼˜åŒ–

```java
@Component
public class EmailBatchProcessor {
    
    private final EmailSender emailSender;
    private final EmailProperties properties;
    
    public List<EmailSendResult> processBatch(List<EmailMessage> messages) {
        int batchSize = properties.getSendStrategy().getBatchSize();
        long batchInterval = properties.getSendStrategy().getBatchInterval();
        
        List<EmailSendResult> results = new ArrayList<>();
        
        // åˆ†æ‰¹å¤„ç†
        for (int i = 0; i < messages.size(); i += batchSize) {
            List<EmailMessage> batch = messages.subList(
                i, Math.min(i + batchSize, messages.size())
            );
            
            // æ‰¹é‡å‘é€
            List<EmailSendResult> batchResults = sendBatch(batch);
            results.addAll(batchResults);
            
            // æ‰¹æ¬¡é—´å»¶è¿Ÿ
            if (i + batchSize < messages.size()) {
                try {
                    Thread.sleep(batchInterval);
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                    break;
                }
            }
        }
        
        return results;
    }
    
    private List<EmailSendResult> sendBatch(List<EmailMessage> batch) {
        return batch.parallelStream()
            .map(this::sendSingleEmail)
            .collect(Collectors.toList());
    }
    
    private EmailSendResult sendSingleEmail(EmailMessage message) {
        try {
            return emailSender.send(message);
        } catch (Exception e) {
            return EmailSendResult.failure(
                message.getMessageId(),
                EmailErrorCode.SEND_FAILED,
                e.getMessage()
            );
        }
    }
}
```

### 2. æ¨¡æ¿å¼•æ“æ¶æ„

#### æ¨¡æ¿å¼•æ“æŠ½è±¡

```java
public interface EmailTemplateEngine {
    
    /**
     * æ¸²æŸ“æ¨¡æ¿
     */
    String render(String templateName, Map<String, Object> params) throws TemplateException;
    
    /**
     * é¢„ç¼–è¯‘æ¨¡æ¿
     */
    void precompile(String templateName) throws TemplateException;
    
    /**
     * æ¸…é™¤æ¨¡æ¿ç¼“å­˜
     */
    void clearCache();
    
    /**
     * è·å–å¼•æ“ç±»å‹
     */
    TemplateEngine getEngineType();
}
```

#### Freemarkerå¼•æ“å®ç°

```java
@Component
@ConditionalOnProperty(name = "slavopolis.email.template.engine", havingValue = "FREEMARKER")
public class FreemarkerEmailTemplateEngine implements EmailTemplateEngine {
    
    private final Configuration freemarkerConfig;
    private final Map<String, Template> templateCache;
    private final EmailProperties.TemplateConfig templateConfig;
    
    public FreemarkerEmailTemplateEngine(EmailProperties properties) {
        this.templateConfig = properties.getTemplate();
        this.templateCache = new ConcurrentHashMap<>();
        this.freemarkerConfig = createFreemarkerConfiguration();
    }
    
    @Override
    public String render(String templateName, Map<String, Object> params) throws TemplateException {
        try {
            Template template = getTemplate(templateName);
            StringWriter writer = new StringWriter();
            template.process(params, writer);
            return writer.toString();
        } catch (Exception e) {
            throw new TemplateException("æ¨¡æ¿æ¸²æŸ“å¤±è´¥: " + templateName, e);
        }
    }
    
    private Template getTemplate(String templateName) throws IOException {
        if (templateConfig.isCacheEnabled()) {
            return templateCache.computeIfAbsent(templateName, this::loadTemplate);
        } else {
            return loadTemplate(templateName);
        }
    }
    
    private Template loadTemplate(String templateName) {
        try {
            String templatePath = templateName + templateConfig.getTemplateSuffix();
            return freemarkerConfig.getTemplate(templatePath);
        } catch (IOException e) {
            throw new TemplateException("æ¨¡æ¿åŠ è½½å¤±è´¥: " + templateName, e);
        }
    }
    
    private Configuration createFreemarkerConfiguration() {
        Configuration config = new Configuration(Configuration.VERSION_2_3_31);
        
        // è®¾ç½®æ¨¡æ¿åŠ è½½å™¨
        try {
            String templatePath = templateConfig.getTemplatePath();
            if (templatePath.startsWith("classpath:")) {
                config.setClassLoaderForTemplateLoading(
                    getClass().getClassLoader(),
                    templatePath.substring("classpath:".length())
                );
            } else {
                config.setDirectoryForTemplateLoading(new File(templatePath));
            }
        } catch (IOException e) {
            throw new EmailConfigurationException("Freemarkeré…ç½®å¤±è´¥", e);
        }
        
        // è®¾ç½®ç¼–ç 
        config.setDefaultEncoding(templateConfig.getEncoding());
        
        // è®¾ç½®å¼‚å¸¸å¤„ç†
        config.setTemplateExceptionHandler(TemplateExceptionHandler.RETHROW_HANDLER);
        
        // è®¾ç½®æ•°å­—æ ¼å¼
        config.setNumberFormat("0.######");
        
        return config;
    }
}
```

### 3. é™æµç³»ç»Ÿè®¾è®¡

#### é™æµç®¡ç†å™¨

```java
@Component
public class EmailRateLimitManager {
    
    private final Map<String, RateLimiter> limiters;
    private final EmailProperties.RateLimit rateLimitConfig;
    private final RedisTemplate<String, String> redisTemplate;
    
    public EmailRateLimitManager(EmailProperties properties, 
                                RedisTemplate<String, String> redisTemplate) {
        this.rateLimitConfig = properties.getRateLimit();
        this.redisTemplate = redisTemplate;
        this.limiters = new ConcurrentHashMap<>();
        
        initializeLimiters();
    }
    
    public boolean tryAcquire(EmailMessage message) {
        if (!rateLimitConfig.isEnabled()) {
            return true;
        }
        
        List<String> limitKeys = buildLimitKeys(message);
        
        for (String key : limitKeys) {
            RateLimiter limiter = limiters.get(key);
            if (limiter != null && !limiter.tryAcquire()) {
                if (rateLimitConfig.isFailOnLimitError()) {
                    throw new EmailRateLimitException("é‚®ä»¶å‘é€é¢‘ç‡è¶…é™: " + key);
                }
                return false;
            }
        }
        
        return true;
    }
    
    private List<String> buildLimitKeys(EmailMessage message) {
        List<String> keys = new ArrayList<>();
        
        // å…¨å±€é™æµ
        keys.add("global");
        
        // æŒ‰å‘é€æ–¹é™æµ
        if (rateLimitConfig.isPerSender()) {
            keys.add("sender:" + message.getFrom());
        }
        
        // æŒ‰æ”¶ä»¶äººé™æµ
        if (rateLimitConfig.isPerRecipient()) {
            message.getTo().forEach(recipient -> 
                keys.add("recipient:" + recipient));
        }
        
        // æŒ‰ä¸šåŠ¡æ ‡ç­¾é™æµ
        if (rateLimitConfig.isPerBusinessTag() && message.getBusinessTag() != null) {
            keys.add("business:" + message.getBusinessTag());
        }
        
        return keys;
    }
    
    private void initializeLimiters() {
        // å…¨å±€é™æµå™¨
        limiters.put("global", RateLimiter.create(
            rateLimitConfig.getMaxSendPerSecond()));
        
        // å…¶ä»–é™æµå™¨æ ¹æ®éœ€è¦åŠ¨æ€åˆ›å»º
    }
}
```

#### æ»‘åŠ¨çª—å£é™æµå®ç°

```java
@Component
public class SlidingWindowRateLimiter {
    
    private final RedisTemplate<String, String> redisTemplate;
    private final String luaScript;
    
    public SlidingWindowRateLimiter(RedisTemplate<String, String> redisTemplate) {
        this.redisTemplate = redisTemplate;
        this.luaScript = loadLuaScript();
    }
    
    public boolean tryAcquire(String key, int maxRequests, Duration window) {
        long windowSizeMs = window.toMillis();
        long currentTime = System.currentTimeMillis();
        
        List<String> keys = Collections.singletonList(key);
        Object[] args = {
            String.valueOf(currentTime),
            String.valueOf(windowSizeMs),
            String.valueOf(maxRequests)
        };
        
        Long result = redisTemplate.execute(
            RedisScript.of(luaScript, Long.class),
            keys,
            args
        );
        
        return result != null && result == 1;
    }
    
    private String loadLuaScript() {
        return """
            local key = KEYS[1]
            local currentTime = tonumber(ARGV[1])
            local windowSize = tonumber(ARGV[2])
            local maxRequests = tonumber(ARGV[3])
            
            local windowStart = currentTime - windowSize
            
            -- æ¸…ç†è¿‡æœŸè®°å½•
            redis.call('ZREMRANGEBYSCORE', key, 0, windowStart)
            
            -- è·å–å½“å‰çª—å£å†…çš„è¯·æ±‚æ•°
            local currentCount = redis.call('ZCARD', key)
            
            if currentCount < maxRequests then
                -- æ·»åŠ å½“å‰è¯·æ±‚
                redis.call('ZADD', key, currentTime, currentTime)
                redis.call('EXPIRE', key, math.ceil(windowSize / 1000))
                return 1
            else
                return 0
            end
            """;
    }
}
```

### 4. çŠ¶æ€ç®¡ç†ç³»ç»Ÿ

#### å‘é€ç»“æœç¼“å­˜

```java
@Component
public class EmailSendResultCache {
    
    private final Cache<String, EmailSendResult> localCache;
    private final RedisTemplate<String, EmailSendResult> redisTemplate;
    private final boolean useRedis;
    
    public EmailSendResultCache(EmailProperties properties,
                               @Autowired(required = false) RedisTemplate<String, EmailSendResult> redisTemplate) {
        this.useRedis = properties.isUseRedisCacheForResults() && redisTemplate != null;
        this.redisTemplate = redisTemplate;
        this.localCache = createLocalCache();
    }
    
    public void put(String messageId, EmailSendResult result) {
        // æœ¬åœ°ç¼“å­˜
        localCache.put(messageId, result);
        
        // Redisç¼“å­˜ï¼ˆå¦‚æœå¯ç”¨ï¼‰
        if (useRedis) {
            try {
                redisTemplate.opsForValue().set(
                    buildRedisKey(messageId), 
                    result, 
                    Duration.ofHours(24)
                );
            } catch (Exception e) {
                log.warn("Redisç¼“å­˜å†™å…¥å¤±è´¥: {}", e.getMessage());
            }
        }
    }
    
    public EmailSendResult get(String messageId) {
        // å…ˆæŸ¥æœ¬åœ°ç¼“å­˜
        EmailSendResult result = localCache.getIfPresent(messageId);
        if (result != null) {
            return result;
        }
        
        // å†æŸ¥Redisç¼“å­˜
        if (useRedis) {
            try {
                result = redisTemplate.opsForValue().get(buildRedisKey(messageId));
                if (result != null) {
                    // å›å†™æœ¬åœ°ç¼“å­˜
                    localCache.put(messageId, result);
                    return result;
                }
            } catch (Exception e) {
                log.warn("Redisç¼“å­˜è¯»å–å¤±è´¥: {}", e.getMessage());
            }
        }
        
        return null;
    }
    
    private Cache<String, EmailSendResult> createLocalCache() {
        return Caffeine.newBuilder()
            .maximumSize(1000)
            .expireAfterWrite(Duration.ofHours(1))
            .build();
    }
    
    private String buildRedisKey(String messageId) {
        return "email:result:" + messageId;
    }
}
```

### 5. ç›‘æ§ç»Ÿè®¡ç³»ç»Ÿ

#### æŒ‡æ ‡æ”¶é›†å™¨

```java
@Component
public class EmailMetricsCollector {
    
    private final MeterRegistry meterRegistry;
    private final Counter sentCounter;
    private final Counter failedCounter;
    private final Timer sendTimer;
    private final Gauge queueSizeGauge;
    
    public EmailMetricsCollector(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.sentCounter = Counter.builder("email.sent.total")
            .description("é‚®ä»¶å‘é€æˆåŠŸæ€»æ•°")
            .register(meterRegistry);
        this.failedCounter = Counter.builder("email.failed.total")
            .description("é‚®ä»¶å‘é€å¤±è´¥æ€»æ•°")
            .register(meterRegistry);
        this.sendTimer = Timer.builder("email.send.duration")
            .description("é‚®ä»¶å‘é€è€—æ—¶")
            .register(meterRegistry);
        this.queueSizeGauge = Gauge.builder("email.queue.size")
            .description("é‚®ä»¶é˜Ÿåˆ—å¤§å°")
            .register(meterRegistry, this, EmailMetricsCollector::getQueueSize);
    }
    
    public void recordSent(EmailMessage message, Duration duration) {
        sentCounter.increment(
            Tags.of(
                "type", message.getEmailType().name(),
                "business_tag", message.getBusinessTag() != null ? message.getBusinessTag() : "unknown"
            )
        );
        sendTimer.record(duration);
    }
    
    public void recordFailed(EmailMessage message, String errorCode) {
        failedCounter.increment(
            Tags.of(
                "type", message.getEmailType().name(),
                "error_code", errorCode,
                "business_tag", message.getBusinessTag() != null ? message.getBusinessTag() : "unknown"
            )
        );
    }
    
    private double getQueueSize() {
        // è·å–å½“å‰é˜Ÿåˆ—å¤§å°çš„é€»è¾‘
        return 0.0;
    }
}
```

## ğŸ”„ å…³é”®è®¾è®¡æ¨¡å¼åº”ç”¨

### 1. ç­–ç•¥æ¨¡å¼ - å‘é€ç­–ç•¥

```java
public interface EmailSendStrategy {
    EmailSendResult send(EmailMessage message);
    CompletableFuture<EmailSendResult> sendAsync(EmailMessage message);
}

@Component
public class SyncEmailSendStrategy implements EmailSendStrategy {
    
    @Override
    public EmailSendResult send(EmailMessage message) {
        // åŒæ­¥å‘é€å®ç°
        return doSend(message);
    }
    
    @Override
    public CompletableFuture<EmailSendResult> sendAsync(EmailMessage message) {
        return CompletableFuture.completedFuture(send(message));
    }
}

@Component
public class AsyncEmailSendStrategy implements EmailSendStrategy {
    
    private final EmailAsyncExecutor asyncExecutor;
    
    @Override
    public EmailSendResult send(EmailMessage message) {
        // å¼‚æ­¥ç­–ç•¥ä¸‹çš„åŒæ­¥è°ƒç”¨
        try {
            return sendAsync(message).get();
        } catch (Exception e) {
            return EmailSendResult.failure(message.getMessageId(), 
                EmailErrorCode.SEND_FAILED, e.getMessage());
        }
    }
    
    @Override
    public CompletableFuture<EmailSendResult> sendAsync(EmailMessage message) {
        return asyncExecutor.executeAsync(message);
    }
}
```

### 2. å·¥å‚æ¨¡å¼ - æ¨¡æ¿å¼•æ“å·¥å‚

```java
@Component
public class EmailTemplateEngineFactory {
    
    private final Map<TemplateEngine, EmailTemplateEngine> engines;
    
    public EmailTemplateEngineFactory(List<EmailTemplateEngine> engineList) {
        this.engines = engineList.stream()
            .collect(Collectors.toMap(
                EmailTemplateEngine::getEngineType,
                Function.identity()
            ));
    }
    
    public EmailTemplateEngine getEngine(TemplateEngine engineType) {
        EmailTemplateEngine engine = engines.get(engineType);
        if (engine == null) {
            throw new EmailConfigurationException("ä¸æ”¯æŒçš„æ¨¡æ¿å¼•æ“: " + engineType);
        }
        return engine;
    }
}
```

### 3. è§‚å¯Ÿè€…æ¨¡å¼ - äº‹ä»¶é€šçŸ¥

```java
@Component
public class EmailEventPublisher {
    
    private final ApplicationEventPublisher eventPublisher;
    
    public void publishSentEvent(EmailMessage message, EmailSendResult result) {
        EmailSentEvent event = new EmailSentEvent(this, message, result);
        eventPublisher.publishEvent(event);
    }
    
    public void publishFailedEvent(EmailMessage message, Exception exception) {
        EmailFailedEvent event = new EmailFailedEvent(this, message, exception);
        eventPublisher.publishEvent(event);
    }
}

@EventListener
@Component
public class EmailEventHandler {
    
    private final EmailMetricsCollector metricsCollector;
    private final EmailAlarmService alarmService;
    
    @EventListener
    public void handleEmailSent(EmailSentEvent event) {
        // è®°å½•æŒ‡æ ‡
        metricsCollector.recordSent(event.getMessage(), event.getDuration());
        
        // æ›´æ–°ç»Ÿè®¡
        updateStatistics(event);
    }
    
    @EventListener
    public void handleEmailFailed(EmailFailedEvent event) {
        // è®°å½•å¤±è´¥æŒ‡æ ‡
        metricsCollector.recordFailed(event.getMessage(), event.getErrorCode());
        
        // è§¦å‘å‘Šè­¦
        alarmService.checkAndAlarm(event);
    }
}
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. è¿æ¥æ± ä¼˜åŒ–

```java
@Configuration
public class EmailConnectionPoolConfig {
    
    @Bean
    public JavaMailSender javaMailSender(EmailProperties properties) {
        JavaMailSenderImpl mailSender = new JavaMailSenderImpl();
        
        // åŸºç¡€é…ç½®
        EmailProperties.SmtpConfig smtp = properties.getSmtp();
        mailSender.setHost(smtp.getHost());
        mailSender.setPort(smtp.getPort());
        mailSender.setUsername(smtp.getUsername());
        mailSender.setPassword(smtp.getPassword());
        
        // è¿æ¥æ± é…ç½®
        Properties props = mailSender.getJavaMailProperties();
        props.put("mail.transport.protocol", "smtp");
        props.put("mail.smtp.auth", smtp.isAuth());
        props.put("mail.smtp.starttls.enable", smtp.isStarttls());
        props.put("mail.smtp.ssl.enable", smtp.isSsl());
        
        // è¿æ¥æ± ä¼˜åŒ–
        props.put("mail.smtp.connectionpoolsize", "10");
        props.put("mail.smtp.connectionpooltimeout", "300000");
        
        // è¶…æ—¶é…ç½®
        props.put("mail.smtp.connectiontimeout", smtp.getConnectionTimeout());
        props.put("mail.smtp.timeout", smtp.getReadTimeout());
        props.put("mail.smtp.writetimeout", smtp.getWriteTimeout());
        
        return mailSender;
    }
}
```

### 2. æ¨¡æ¿ç¼“å­˜ä¼˜åŒ–

```java
@Component
public class EmailTemplateCache {
    
    private final Cache<String, String> renderedCache;
    private final Cache<String, Template> templateCache;
    private final EmailProperties.TemplateConfig config;
    
    public EmailTemplateCache(EmailProperties properties) {
        this.config = properties.getTemplate();
        this.renderedCache = createRenderedCache();
        this.templateCache = createTemplateCache();
    }
    
    public String getRenderedContent(String templateName, Map<String, Object> params) {
        if (!config.isCacheEnabled()) {
            return renderTemplate(templateName, params);
        }
        
        String cacheKey = buildCacheKey(templateName, params);
        return renderedCache.get(cacheKey, key -> renderTemplate(templateName, params));
    }
    
    private Cache<String, String> createRenderedCache() {
        return Caffeine.newBuilder()
            .maximumSize(config.getCacheSize())
            .expireAfterWrite(Duration.ofSeconds(config.getCacheUpdateDelay()))
            .build();
    }
    
    private Cache<String, Template> createTemplateCache() {
        return Caffeine.newBuilder()
            .maximumSize(config.getCacheSize())
            .build();
    }
    
    private String buildCacheKey(String templateName, Map<String, Object> params) {
        // æ„å»ºç¼“å­˜é”®ï¼Œè€ƒè™‘å‚æ•°å˜åŒ–
        return templateName + ":" + params.hashCode();
    }
}
```

### 3. æ‰¹é‡å‘é€ä¼˜åŒ–

```java
@Component
public class OptimizedBatchProcessor {
    
    private final EmailSender emailSender;
    private final EmailProperties properties;
    private final Semaphore concurrencyLimiter;
    
    public OptimizedBatchProcessor(EmailProperties properties) {
        this.properties = properties;
        this.concurrencyLimiter = new Semaphore(
            properties.getSendStrategy().getAsyncPoolSize()
        );
    }
    
    public CompletableFuture<List<EmailSendResult>> processBatchAsync(
            List<EmailMessage> messages) {
        
        int batchSize = properties.getSendStrategy().getBatchSize();
        List<CompletableFuture<List<EmailSendResult>>> futures = new ArrayList<>();
        
        // åˆ†æ‰¹å¹¶è¡Œå¤„ç†
        for (int i = 0; i < messages.size(); i += batchSize) {
            List<EmailMessage> batch = messages.subList(
                i, Math.min(i + batchSize, messages.size())
            );
            
            CompletableFuture<List<EmailSendResult>> future = 
                processSingleBatchAsync(batch);
            futures.add(future);
        }
        
        // åˆå¹¶æ‰€æœ‰ç»“æœ
        return CompletableFuture.allOf(futures.toArray(new CompletableFuture[0]))
            .thenApply(v -> futures.stream()
                .map(CompletableFuture::join)
                .flatMap(List::stream)
                .collect(Collectors.toList()));
    }
    
    private CompletableFuture<List<EmailSendResult>> processSingleBatchAsync(
            List<EmailMessage> batch) {
        
        return CompletableFuture.supplyAsync(() -> {
            try {
                concurrencyLimiter.acquire();
                return batch.parallelStream()
                    .map(this::sendWithRetry)
                    .collect(Collectors.toList());
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                return batch.stream()
                    .map(msg -> EmailSendResult.failure(msg.getMessageId(), 
                        EmailErrorCode.SEND_INTERRUPTED, "å‘é€è¢«ä¸­æ–­"))
                    .collect(Collectors.toList());
            } finally {
                concurrencyLimiter.release();
            }
        });
    }
    
    private EmailSendResult sendWithRetry(EmailMessage message) {
        int maxRetries = message.getSendConfig().getMaxRetries();
        long retryInterval = message.getSendConfig().getRetryInterval();
        
        for (int attempt = 0; attempt <= maxRetries; attempt++) {
            try {
                return emailSender.send(message);
            } catch (Exception e) {
                if (attempt == maxRetries) {
                    return EmailSendResult.failure(message.getMessageId(),
                        EmailErrorCode.SEND_FAILED, e.getMessage());
                }
                
                try {
                    Thread.sleep(retryInterval * (attempt + 1));
                } catch (InterruptedException ie) {
                    Thread.currentThread().interrupt();
                    return EmailSendResult.failure(message.getMessageId(),
                        EmailErrorCode.SEND_INTERRUPTED, "é‡è¯•è¢«ä¸­æ–­");
                }
            }
        }
        
        return EmailSendResult.failure(message.getMessageId(),
            EmailErrorCode.SEND_FAILED, "é‡è¯•æ¬¡æ•°è€—å°½");
    }
}
```

## ğŸ”’ å®‰å…¨æ€§è®¾è®¡

### 1. è¾“å…¥éªŒè¯å’Œè¿‡æ»¤

```java
@Component
public class EmailSecurityValidator {
    
    private final Pattern emailPattern = Pattern.compile(
        "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$"
    );
    
    private final List<String> dangerousPatterns = Arrays.asList(
        "<script", "javascript:", "vbscript:", "onload=", "onerror="
    );
    
    public void validateEmailMessage(EmailMessage message) {
        // éªŒè¯é‚®ç®±åœ°å€
        validateEmailAddresses(message);
        
        // éªŒè¯é‚®ä»¶å†…å®¹
        validateContent(message);
        
        // éªŒè¯é™„ä»¶
        validateAttachments(message);
    }
    
    private void validateEmailAddresses(EmailMessage message) {
        // éªŒè¯å‘é€æ–¹
        if (!isValidEmail(message.getFrom())) {
            throw new EmailValidationException("å‘é€æ–¹é‚®ç®±åœ°å€æ— æ•ˆ: " + message.getFrom());
        }
        
        // éªŒè¯æ”¶ä»¶äºº
        message.getTo().forEach(email -> {
            if (!isValidEmail(email)) {
                throw new EmailValidationException("æ”¶ä»¶äººé‚®ç®±åœ°å€æ— æ•ˆ: " + email);
            }
        });
        
        // éªŒè¯æŠ„é€äºº
        if (message.getCc() != null) {
            message.getCc().forEach(email -> {
                if (!isValidEmail(email)) {
                    throw new EmailValidationException("æŠ„é€äººé‚®ç®±åœ°å€æ— æ•ˆ: " + email);
                }
            });
        }
    }
    
    private void validateContent(EmailMessage message) {
        // HTMLå†…å®¹XSSè¿‡æ»¤
        if (message.getHtml() != null) {
            String sanitizedHtml = sanitizeHtml(message.getHtml());
            message.setHtml(sanitizedHtml);
        }
        
        // æ–‡æœ¬å†…å®¹è¿‡æ»¤
        if (message.getText() != null) {
            String sanitizedText = sanitizeText(message.getText());
            message.setText(sanitizedText);
        }
    }
    
    private void validateAttachments(EmailMessage message) {
        if (message.getAttachments() != null) {
            message.getAttachments().forEach(attachment -> {
                // éªŒè¯æ–‡ä»¶ç±»å‹
                validateFileType(attachment);
                
                // éªŒè¯æ–‡ä»¶å¤§å°
                validateFileSize(attachment);
                
                // éªŒè¯æ–‡ä»¶å
                validateFileName(attachment);
            });
        }
    }
    
    private boolean isValidEmail(String email) {
        return email != null && emailPattern.matcher(email).matches();
    }
    
    private String sanitizeHtml(String html) {
        // ä½¿ç”¨OWASP Java HTML Sanitizeræˆ–ç±»ä¼¼åº“
        return Jsoup.clean(html, Whitelist.relaxed());
    }
    
    private String sanitizeText(String text) {
        // ç§»é™¤å±é™©å­—ç¬¦å’Œæ¨¡å¼
        String sanitized = text;
        for (String pattern : dangerousPatterns) {
            sanitized = sanitized.replaceAll("(?i)" + Pattern.quote(pattern), "");
        }
        return sanitized;
    }
}
```

### 2. è®¿é—®æ§åˆ¶å’Œæƒé™ç®¡ç†

```java
@Component
public class EmailAccessController {
    
    private final EmailProperties properties;
    private final RedisTemplate<String, String> redisTemplate;
    
    public boolean checkSendPermission(String sender, EmailMessage message) {
        // æ£€æŸ¥å‘é€æ–¹æƒé™
        if (!isAuthorizedSender(sender)) {
            throw new EmailAccessDeniedException("å‘é€æ–¹æœªæˆæƒ: " + sender);
        }
        
        // æ£€æŸ¥æ”¶ä»¶äººé™åˆ¶
        if (!checkRecipientRestrictions(message)) {
            throw new EmailAccessDeniedException("æ”¶ä»¶äººå—é™");
        }
        
        // æ£€æŸ¥å†…å®¹é™åˆ¶
        if (!checkContentRestrictions(message)) {
            throw new EmailAccessDeniedException("é‚®ä»¶å†…å®¹å—é™");
        }
        
        return true;
    }
    
    private boolean isAuthorizedSender(String sender) {
        // æ£€æŸ¥å‘é€æ–¹ç™½åå•
        List<String> authorizedSenders = properties.getSecurity().getAuthorizedSenders();
        return authorizedSenders.isEmpty() || authorizedSenders.contains(sender);
    }
    
    private boolean checkRecipientRestrictions(EmailMessage message) {
        // æ£€æŸ¥æ”¶ä»¶äººé»‘åå•
        List<String> blockedRecipients = properties.getSecurity().getBlockedRecipients();
        return message.getTo().stream()
            .noneMatch(blockedRecipients::contains);
    }
    
    private boolean checkContentRestrictions(EmailMessage message) {
        // æ£€æŸ¥æ•æ„Ÿè¯
        List<String> sensitiveWords = properties.getSecurity().getSensitiveWords();
        String content = (message.getText() != null ? message.getText() : "") +
                        (message.getHtml() != null ? message.getHtml() : "");
        
        return sensitiveWords.stream()
            .noneMatch(word -> content.toLowerCase().contains(word.toLowerCase()));
    }
}
```

## ğŸ“Š ç›‘æ§å’Œè¿ç»´

### 1. å¥åº·æ£€æŸ¥

```java
@Component
public class EmailHealthIndicator implements HealthIndicator {
    
    private final EmailService emailService;
    private final EmailProperties properties;
    
    @Override
    public Health health() {
        try {
            // æ£€æŸ¥SMTPè¿æ¥
            boolean smtpConnected = emailService.testConnection();
            if (!smtpConnected) {
                return Health.down()
                    .withDetail("smtp", "è¿æ¥å¤±è´¥")
                    .build();
            }
            
            // æ£€æŸ¥é˜Ÿåˆ—çŠ¶æ€
            EmailService.EmailServiceStatus status = emailService.getServiceStatus();
            
            // æ£€æŸ¥é™æµçŠ¶æ€
            boolean rateLimitHealthy = checkRateLimitHealth();
            
            Health.Builder builder = Health.up()
                .withDetail("smtp", "è¿æ¥æ­£å¸¸")
                .withDetail("uptime", status.uptime())
                .withDetail("version", status.version())
                .withDetail("rateLimit", rateLimitHealthy ? "æ­£å¸¸" : "å¼‚å¸¸");
            
            return builder.build();
            
        } catch (Exception e) {
            return Health.down()
                .withDetail("error", e.getMessage())
                .build();
        }
    }
    
    private boolean checkRateLimitHealth() {
        // æ£€æŸ¥é™æµç»„ä»¶æ˜¯å¦æ­£å¸¸å·¥ä½œ
        return true;
    }
}
```

### 2. æŒ‡æ ‡æš´éœ²

```java
@Component
public class EmailMetricsEndpoint {
    
    private final EmailMetricsCollector metricsCollector;
    private final EmailSendResultCache resultCache;
    
    @EventListener
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
    public void updateMetrics() {
        // æ›´æ–°é˜Ÿåˆ—å¤§å°æŒ‡æ ‡
        updateQueueSizeMetric();
        
        // æ›´æ–°ç¼“å­˜å‘½ä¸­ç‡æŒ‡æ ‡
        updateCacheHitRateMetric();
        
        // æ›´æ–°é”™è¯¯ç‡æŒ‡æ ‡
        updateErrorRateMetric();
    }
    
    private void updateQueueSizeMetric() {
        // å®ç°é˜Ÿåˆ—å¤§å°ç»Ÿè®¡
    }
    
    private void updateCacheHitRateMetric() {
        // å®ç°ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡
    }
    
    private void updateErrorRateMetric() {
        // å®ç°é”™è¯¯ç‡ç»Ÿè®¡
    }
}
```

## ğŸ”® æŠ€æœ¯æ¼”è¿›æ–¹å‘

### V2.0 åŠŸèƒ½å¢å¼ºè§„åˆ’

**1. æ™ºèƒ½åŒ–ç‰¹æ€§**
- AIé©±åŠ¨çš„é‚®ä»¶å†…å®¹ä¼˜åŒ–å»ºè®®
- æ™ºèƒ½å‘é€æ—¶é—´æ¨è
- è‡ªé€‚åº”é™æµç®—æ³•

**2. é«˜çº§æ¨¡æ¿åŠŸèƒ½**
- å¯è§†åŒ–æ¨¡æ¿ç¼–è¾‘å™¨
- æ¨¡æ¿ç‰ˆæœ¬ç®¡ç†
- A/Bæµ‹è¯•æ”¯æŒ

**3. å¢å¼ºç›‘æ§èƒ½åŠ›**
- å®æ—¶ç›‘æ§é¢æ¿
- æ™ºèƒ½å‘Šè­¦è§„åˆ™
- æ€§èƒ½åˆ†ææŠ¥å‘Š

**4. æ‰©å±•é›†æˆèƒ½åŠ›**
- å¤šé‚®ä»¶æœåŠ¡å•†æ”¯æŒ
- æ¶ˆæ¯é˜Ÿåˆ—é›†æˆ
- å¾®æœåŠ¡æ²»ç†é›†æˆ

### æ€§èƒ½ä¼˜åŒ–è·¯çº¿å›¾

**1. æ¶æ„ä¼˜åŒ–**
- å“åº”å¼ç¼–ç¨‹æ¨¡å‹
- äº‹ä»¶é©±åŠ¨æ¶æ„
- åˆ†å¸ƒå¼ç¼“å­˜ä¼˜åŒ–

**2. ç®—æ³•ä¼˜åŒ–**
- æ™ºèƒ½æ‰¹é‡åˆå¹¶ç®—æ³•
- åŠ¨æ€è´Ÿè½½å‡è¡¡
- é¢„æµ‹æ€§ç¼“å­˜é¢„çƒ­

**3. èµ„æºä¼˜åŒ–**
- å†…å­˜ä½¿ç”¨ä¼˜åŒ–
- ç½‘ç»œä¼ è¾“ä¼˜åŒ–
- å­˜å‚¨è®¿é—®ä¼˜åŒ–

## ğŸ“ æ€»ç»“

Slavopolis Email æ¨¡å—é€šè¿‡ç²¾å¿ƒçš„æ¶æ„è®¾è®¡å’ŒæŠ€æœ¯å®ç°ï¼Œä¸ºä¼ä¸šçº§åº”ç”¨æä¾›äº†ä¸€ä¸ªåŠŸèƒ½å®Œå¤‡ã€æ€§èƒ½ä¼˜å¼‚ã€æ˜“äºä½¿ç”¨çš„é‚®ä»¶æœåŠ¡è§£å†³æ–¹æ¡ˆã€‚

**æ ¸å¿ƒæŠ€æœ¯äº®ç‚¹**ï¼š

- âœ… **åˆ†å±‚æ¶æ„**ï¼šæ¸…æ™°çš„èŒè´£åˆ†ç¦»å’Œæ¨¡å—åŒ–è®¾è®¡
- âœ… **å¼‚æ­¥å¤„ç†**ï¼šé«˜æ€§èƒ½çš„å¼‚æ­¥å‘é€å’Œæ‰¹é‡å¤„ç†æœºåˆ¶
- âœ… **æ¨¡æ¿å¼•æ“**ï¼šçµæ´»çš„å¤šå¼•æ“æ”¯æŒå’Œç¼“å­˜ä¼˜åŒ–
- âœ… **é™æµä¿æŠ¤**ï¼šå¤šç»´åº¦çš„æ™ºèƒ½é™æµç­–ç•¥
- âœ… **çŠ¶æ€ç®¡ç†**ï¼šåˆ†å¸ƒå¼å‹å¥½çš„çŠ¶æ€ç¼“å­˜æœºåˆ¶
- âœ… **ç›‘æ§è¿ç»´**ï¼šå®Œå–„çš„æŒ‡æ ‡æ”¶é›†å’Œå¥åº·æ£€æŸ¥
- âœ… **å®‰å…¨é˜²æŠ¤**ï¼šå…¨é¢çš„è¾“å…¥éªŒè¯å’Œè®¿é—®æ§åˆ¶

**è®¾è®¡ä»·å€¼**ï¼š

é€šè¿‡æœ¬æŠ€æœ¯è§£æï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸€ä¸ªä¼˜ç§€çš„ä¼ä¸šçº§ç»„ä»¶ä¸ä»…è¦è§£å†³åŸºæœ¬çš„åŠŸèƒ½éœ€æ±‚ï¼Œæ›´è¦åœ¨æ¶æ„è®¾è®¡ã€æ€§èƒ½ä¼˜åŒ–ã€å®‰å…¨é˜²æŠ¤ã€è¿ç»´ç›‘æ§ç­‰å¤šä¸ªç»´åº¦è¿›è¡Œæ·±å…¥æ€è€ƒå’Œç²¾å¿ƒè®¾è®¡ã€‚Slavopolis Email çš„è®¾è®¡æ€è·¯å’Œå®ç°æ–¹æ¡ˆï¼Œä¸ºç±»ä¼¼ç³»ç»Ÿçš„å¼€å‘æä¾›äº†æœ‰ä»·å€¼çš„å‚è€ƒã€‚

## ğŸ“š å‚è€ƒèµ„æ–™

- [Spring Boot Mail å®˜æ–¹æ–‡æ¡£](https://docs.spring.io/spring-boot/docs/current/reference/html/io.html#io.email)
- [JavaMail API è§„èŒƒ](https://javaee.github.io/javamail/)
- [Freemarker å®˜æ–¹æ–‡æ¡£](https://freemarker.apache.org/docs/)
- [Micrometer ç›‘æ§æ¡†æ¶](https://micrometer.io/docs)
- [Redis å®˜æ–¹æ–‡æ¡£](https://redis.io/documentation)
- [OWASP å®‰å…¨æŒ‡å—](https://owasp.org/www-project-top-ten/)
