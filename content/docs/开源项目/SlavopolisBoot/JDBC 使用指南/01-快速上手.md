# å¿«é€Ÿä¸Šæ‰‹

## å‰è¨€

åœ¨ç°ä»£Javaä¼ä¸šçº§å¼€å‘ä¸­ï¼Œæ•°æ®è®¿é—®å±‚çš„è®¾è®¡å¾€å¾€é¢ä¸´ç€è¯¸å¤šæŒ‘æˆ˜ï¼šSQLæ³¨å…¥é£é™©ã€äº‹åŠ¡ç®¡ç†å¤æ‚æ€§ã€ç»“æœé›†æ˜ å°„ç¹çã€æ€§èƒ½ç›‘æ§ç¼ºå¤±ç­‰é—®é¢˜ã€‚ä¼ ç»Ÿçš„Spring JDBCè™½ç„¶æä¾›äº†åŸºç¡€çš„æ•°æ®è®¿é—®èƒ½åŠ›ï¼Œä½†åœ¨ä¼ä¸šçº§åº”ç”¨ä¸­ä»æ˜¾ä¸è¶³ã€‚

**Slavopolis-JDBC** æ˜¯ä¸€ä¸ªåŸºäºSpring NamedParameterJdbcTemplateçš„å¢å¼ºå‹æ•°æ®è®¿é—®è§£å†³æ–¹æ¡ˆï¼Œä¸“ä¸ºè§£å†³ä¼ä¸šçº§å¼€å‘ä¸­çš„å®é™…ç—›ç‚¹è€Œè®¾è®¡ã€‚å®ƒä¸ä»…ä¿æŒäº†Spring JDBCçš„ç®€æ´æ€§å’Œé«˜æ€§èƒ½ï¼Œæ›´åœ¨å®‰å…¨æ€§ã€æ˜“ç”¨æ€§ã€ç›‘æ§èƒ½åŠ›ç­‰æ–¹é¢è¿›è¡Œäº†å…¨é¢å¢å¼ºã€‚

### ğŸ¯ æ ¸å¿ƒä»·å€¼

- **ğŸ›¡ï¸ ä¼ä¸šçº§å®‰å…¨é˜²æŠ¤**ï¼šå†…ç½®SQLæ³¨å…¥æ£€æµ‹ã€æ•æ„Ÿä¿¡æ¯æ©ç ã€å‚æ•°éªŒè¯ç­‰å¤šé‡å®‰å…¨æœºåˆ¶
- **ğŸš€ å¼€ç®±å³ç”¨**ï¼šé›¶é…ç½®å¯åŠ¨ï¼ŒSpring Bootè‡ªåŠ¨è£…é…ï¼Œ5åˆ†é’Ÿå¿«é€Ÿé›†æˆ
- **ğŸ“Š å…¨é¢ç›‘æ§èƒ½åŠ›**ï¼šSQLæ‰§è¡Œç›‘æ§ã€æ…¢æŸ¥è¯¢æ£€æµ‹ã€æ€§èƒ½ç»Ÿè®¡ç­‰ç”Ÿäº§çº§ç›‘æ§åŠŸèƒ½
- **ğŸ¨ æ™ºèƒ½ç»“æœæ˜ å°„**ï¼šè‡ªåŠ¨é©¼å³°è½¬æ¢ã€ç±»å‹å®‰å…¨æ˜ å°„ã€ç¼“å­˜ä¼˜åŒ–ç­‰æ™ºèƒ½ç‰¹æ€§
- **âš¡ é«˜æ€§èƒ½è®¾è®¡**ï¼šè¿æ¥æ± ä¼˜åŒ–ã€æ‰¹å¤„ç†æ”¯æŒã€åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–ç­‰æ€§èƒ½ç‰¹æ€§

### ğŸ“– é€‚ç”¨åœºæ™¯

- éœ€è¦é«˜å®‰å…¨æ€§çš„ä¼ä¸šçº§åº”ç”¨
- å¯¹SQLæ‰§è¡Œæ€§èƒ½æœ‰ç›‘æ§éœ€æ±‚çš„ç³»ç»Ÿ
- å¸Œæœ›ç®€åŒ–æ•°æ®è®¿é—®å±‚å¼€å‘çš„é¡¹ç›®
- éœ€è¦ç±»å‹å®‰å…¨å’Œæ™ºèƒ½æ˜ å°„çš„åº”ç”¨

## å¿«é€Ÿå¼€å§‹

### 1. æ·»åŠ ä¾èµ–

åœ¨æ‚¨çš„Spring Booté¡¹ç›®ä¸­æ·»åŠ Slavopolis-JDBCä¾èµ–ï¼š

```xml
<dependency>
    <groupId>club.slavopolis</groupId>
    <artifactId>slavopolis-jdbc</artifactId>
    <version>1.0.0-SNAPSHOT</version>
</dependency>
```

### 2. æ•°æ®æºé…ç½®

åœ¨`application.yml`ä¸­é…ç½®æ•°æ®æºï¼š

```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/your_database
    username: your_username
    password: your_password
    driver-class-name: com.mysql.cj.jdbc.Driver
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
```

### 3. å¯ç”¨Slavopolis-JDBC

æ¨¡å—é‡‡ç”¨Spring Bootè‡ªåŠ¨è£…é…æœºåˆ¶ï¼Œæ— éœ€é¢å¤–é…ç½®å³å¯ä½¿ç”¨ã€‚å¦‚éœ€è‡ªå®šä¹‰é…ç½®ï¼Œå¯åœ¨`application.yml`ä¸­æ·»åŠ ï¼š

```yaml
slavopolis:
  jdbc:
    # åŸºç¡€é…ç½®
    enabled: true
    default-logging-enabled: true
    default-page-size: 20
    max-page-size: 1000
    
    # å®‰å…¨é…ç½®
    security:
      enabled: true
      sql-injection-detection: true
      parameter-validation: true
      sensitive-data-masking: true
```

### 4. æ³¨å…¥ä½¿ç”¨

åœ¨æ‚¨çš„Serviceç±»ä¸­æ³¨å…¥`JdbcOperations`æ¥å£ï¼š

```java
@Service
@Slf4j
public class UserService {
    
    private final JdbcOperations jdbcOperations;
    
    public UserService(JdbcOperations jdbcOperations) {
        this.jdbcOperations = jdbcOperations;
    }
    
    public User findById(Long id) {
        String sql = "SELECT * FROM users WHERE id = :id";
        Map<String, Object> params = Map.of("id", id);
        return jdbcOperations.queryForObject(sql, params, User.class);
    }
}
```

## æ ¸å¿ƒåŠŸèƒ½è¯¦è§£

### ğŸ” æŸ¥è¯¢æ“ä½œ

#### åŸºæœ¬ç±»å‹æŸ¥è¯¢

```java
// æŸ¥è¯¢å•ä¸ªæ•´æ•°
Integer count = jdbcOperations.queryForInt(
    "SELECT COUNT(*) FROM users WHERE status = :status", 
    Map.of("status", "ACTIVE")
);

// æŸ¥è¯¢å•ä¸ªå­—ç¬¦ä¸²
String username = jdbcOperations.queryForString(
    "SELECT username FROM users WHERE id = :id", 
    Map.of("id", 1L)
);

// æŸ¥è¯¢å•ä¸ªé•¿æ•´æ•°
Long maxId = jdbcOperations.queryForLong(
    "SELECT MAX(id) FROM users", 
    Collections.emptyMap()
);
```

#### å¯¹è±¡æŸ¥è¯¢

```java
// æŸ¥è¯¢å•ä¸ªå¯¹è±¡ï¼ˆè‡ªåŠ¨æ˜ å°„ï¼‰
User user = jdbcOperations.queryForObject(
    "SELECT id, username, email, created_time FROM users WHERE id = :id",
    Map.of("id", 1L),
    User.class
);

// æŸ¥è¯¢å¯é€‰å¯¹è±¡
Optional<User> optionalUser = jdbcOperations.queryForOptional(
    "SELECT * FROM users WHERE email = :email",
    Map.of("email", "user@example.com"),
    User.class
);

// ä½¿ç”¨è‡ªå®šä¹‰RowMapper
User customUser = jdbcOperations.queryForObject(
    "SELECT * FROM users WHERE id = :id",
    Map.of("id", 1L),
    (rs, rowNum) -> User.builder()
        .id(rs.getLong("id"))
        .username(rs.getString("username"))
        .email(rs.getString("email"))
        .build()
);
```

#### åˆ—è¡¨æŸ¥è¯¢

```java
// æŸ¥è¯¢å¯¹è±¡åˆ—è¡¨
List<User> users = jdbcOperations.queryForList(
    "SELECT * FROM users WHERE status = :status ORDER BY created_time DESC",
    Map.of("status", "ACTIVE"),
    User.class
);

// æŸ¥è¯¢Mapåˆ—è¡¨
List<Map<String, Object>> userMaps = jdbcOperations.queryForList(
    "SELECT id, username, email FROM users WHERE department_id = :deptId",
    Map.of("deptId", 10L)
);

// æŸ¥è¯¢Mapåˆ—è¡¨ï¼ˆæŒ‡å®šé”®åæ ¼å¼ï¼‰
List<Map<String, Object>> camelCaseUsers = jdbcOperations.queryForList(
    "SELECT user_id, user_name, email_address FROM users",
    Collections.emptyMap(),
    "camelCase"  // è‡ªåŠ¨è½¬æ¢ä¸ºé©¼å³°å‘½å
);
```

#### åˆ†é¡µæŸ¥è¯¢

```java
// åˆ†é¡µæŸ¥è¯¢å¯¹è±¡
PageResult.PageData<User> userPage = jdbcOperations.queryForPage(
    "SELECT * FROM users WHERE status = :status ORDER BY created_time DESC",
    Map.of("status", "ACTIVE"),
    User.class,
    1,  // é¡µç 
    20  // é¡µå¤§å°
);

// åˆ†é¡µæŸ¥è¯¢Map
PageResult.PageData<Map<String, Object>> mapPage = jdbcOperations.queryForPage(
    "SELECT id, username, email FROM users WHERE department_id = :deptId",
    Map.of("deptId", 10L),
    2,  // é¡µç 
    15  // é¡µå¤§å°
);

// è®¿é—®åˆ†é¡µç»“æœ
System.out.println("æ€»è®°å½•æ•°: " + userPage.getTotal());
System.out.println("å½“å‰é¡µç : " + userPage.getCurrent());
System.out.println("é¡µå¤§å°: " + userPage.getSize());
System.out.println("æ˜¯å¦é¦–é¡µ: " + userPage.isFirst());
System.out.println("æ˜¯å¦æœ«é¡µ: " + userPage.isLast());
List<User> records = userPage.getRecords();
```

### âœï¸ æ›´æ–°æ“ä½œ

#### åŸºæœ¬æ›´æ–°

```java
// æ’å…¥è®°å½•
int insertCount = jdbcOperations.update(
    "INSERT INTO users (username, email, password, created_time) " +
    "VALUES (:username, :email, :password, :createdTime)",
    Map.of(
        "username", "newuser",
        "email", "newuser@example.com", 
        "password", "encrypted_password",
        "createdTime", LocalDateTime.now()
    )
);

// æ›´æ–°è®°å½•
int updateCount = jdbcOperations.update(
    "UPDATE users SET email = :email, updated_time = :updatedTime WHERE id = :id",
    Map.of(
        "email", "updated@example.com",
        "updatedTime", LocalDateTime.now(),
        "id", 1L
    )
);

// åˆ é™¤è®°å½•
int deleteCount = jdbcOperations.update(
    "DELETE FROM users WHERE status = :status AND created_time < :beforeDate",
    Map.of(
        "status", "INACTIVE",
        "beforeDate", LocalDateTime.now().minusMonths(6)
    )
);
```

#### è·å–è‡ªå¢ä¸»é”®

```java
// ä½¿ç”¨TypeSafeParameterSourceæ’å…¥å¹¶è·å–ä¸»é”®
TypeSafeParameterSource paramSource = new TypeSafeParameterSource()
    .addValue("username", "newuser")
    .addValue("email", "newuser@example.com")
    .addValue("password", "encrypted_password");

Number generatedId = jdbcOperations.updateAndReturnKey(
    "INSERT INTO users (username, email, password) VALUES (:username, :email, :password)",
    paramSource
);

System.out.println("æ–°æ’å…¥è®°å½•çš„ID: " + generatedId.longValue());
```

### ğŸ”„ æ‰¹å¤„ç†æ“ä½œ

```java
// æ‰¹é‡æ’å…¥ç”¨æˆ·
Map<String, Object>[] batchParams = new Map[3];
batchParams[0] = Map.of("username", "user1", "email", "user1@example.com");
batchParams[1] = Map.of("username", "user2", "email", "user2@example.com");
batchParams[2] = Map.of("username", "user3", "email", "user3@example.com");

int[] results = jdbcOperations.batchUpdate(
    "INSERT INTO users (username, email) VALUES (:username, :email)",
    batchParams
);

// ä½¿ç”¨TypeSafeParameterSourceæ‰¹å¤„ç†
TypeSafeParameterSource[] typeSafeBatch = new TypeSafeParameterSource[2];
typeSafeBatch[0] = new TypeSafeParameterSource()
    .addValue("id", 1L)
    .addValue("status", "ACTIVE");
typeSafeBatch[1] = new TypeSafeParameterSource()
    .addValue("id", 2L)
    .addValue("status", "INACTIVE");

int[] updateResults = jdbcOperations.batchUpdate(
    "UPDATE users SET status = :status WHERE id = :id",
    typeSafeBatch
);
```

### ğŸ”„ äº‹åŠ¡ç®¡ç†

#### ç¼–ç¨‹å¼äº‹åŠ¡

```java
// æ‰‹åŠ¨äº‹åŠ¡ç®¡ç†
TransactionStatus transaction = jdbcOperations.beginTransaction();
try {
    // æ‰§è¡Œå¤šä¸ªæ•°æ®åº“æ“ä½œ
    jdbcOperations.update(
        "INSERT INTO users (username, email) VALUES (:username, :email)",
        Map.of("username", "user1", "email", "user1@example.com")
    );
    
    jdbcOperations.update(
        "INSERT INTO user_profiles (user_id, nickname) VALUES (:userId, :nickname)",
        Map.of("userId", 1L, "nickname", "User One")
    );
    
    // æäº¤äº‹åŠ¡
    jdbcOperations.commitTransaction(transaction);
} catch (Exception e) {
    // å›æ»šäº‹åŠ¡
    jdbcOperations.rollbackTransaction(transaction);
    throw e;
}
```

#### å›è°ƒå¼äº‹åŠ¡

```java
// ä½¿ç”¨äº‹åŠ¡å›è°ƒ
User result = jdbcOperations.executeInTransaction(status -> {
    // æ’å…¥ç”¨æˆ·
    jdbcOperations.update(
        "INSERT INTO users (username, email) VALUES (:username, :email)",
        Map.of("username", "transactional_user", "email", "tx@example.com")
    );
    
    // æŸ¥è¯¢åˆšæ’å…¥çš„ç”¨æˆ·
    return jdbcOperations.queryForObject(
        "SELECT * FROM users WHERE email = :email",
        Map.of("email", "tx@example.com"),
        User.class
    );
});

// æ— è¿”å›å€¼çš„äº‹åŠ¡æ“ä½œ
jdbcOperations.executeInTransaction(() -> {
    jdbcOperations.update("UPDATE users SET status = 'PROCESSED' WHERE status = 'PENDING'");
    jdbcOperations.update("INSERT INTO audit_log (action, timestamp) VALUES ('BATCH_PROCESS', NOW())");
});
```

### ğŸ“ å­˜å‚¨è¿‡ç¨‹è°ƒç”¨

```java
// è°ƒç”¨å­˜å‚¨è¿‡ç¨‹
jdbcOperations.callProcedure(
    "CALL update_user_statistics(:userId, :statisticsDate)",
    Map.of(
        "userId", 1L,
        "statisticsDate", LocalDate.now()
    )
);

// è°ƒç”¨å‡½æ•°å¹¶è·å–è¿”å›å€¼
Integer result = jdbcOperations.callProcedureForInt(
    "SELECT calculate_user_score(:userId, :period)",
    Map.of(
        "userId", 1L,
        "period", "MONTHLY"
    )
);

String status = jdbcOperations.callProcedureForString(
    "SELECT get_user_status(:userId)",
    Map.of("userId", 1L)
);
```

## é«˜çº§ç‰¹æ€§

### ğŸ›¡ï¸ å®‰å…¨é˜²æŠ¤

#### SQLæ³¨å…¥é˜²æŠ¤

æ¨¡å—å†…ç½®äº†å¤šå±‚SQLæ³¨å…¥é˜²æŠ¤æœºåˆ¶ï¼š

```java
// è‡ªåŠ¨æ£€æµ‹å’Œé˜»æ­¢SQLæ³¨å…¥
try {
    // è¿™ç§æ¶æ„å‚æ•°ä¼šè¢«è‡ªåŠ¨æ£€æµ‹å’Œé˜»æ­¢
    Map<String, Object> maliciousParams = Map.of(
        "username", "admin'; DROP TABLE users; --"
    );
    
    jdbcOperations.queryForObject(
        "SELECT * FROM users WHERE username = :username",
        maliciousParams,
        User.class
    );
} catch (SecurityException e) {
    log.warn("SQLæ³¨å…¥æ”»å‡»è¢«é˜»æ­¢: {}", e.getMessage());
}
```

#### æ•æ„Ÿä¿¡æ¯æ©ç 

```java
// æ•æ„Ÿå‚æ•°è‡ªåŠ¨æ©ç ï¼ˆæ—¥å¿—ä¸­ä¸ä¼šæ˜¾ç¤ºçœŸå®å¯†ç ï¼‰
jdbcOperations.update(
    "UPDATE users SET password = :password WHERE id = :id",
    Map.of(
        "password", "user_secret_password",  // æ—¥å¿—ä¸­æ˜¾ç¤ºä¸º "***"
        "id", 1L
    ),
    true  // å¯ç”¨æ—¥å¿—
);
```

### ğŸ“Š ç›‘æ§ç»Ÿè®¡

```java
@Service
public class DatabaseMonitorService {
    
    private final EnhancedJdbcTemplate jdbcTemplate;
    
    public void printStatistics() {
        // è·å–æŸ¥è¯¢ç»Ÿè®¡
        QueryStatistics queryStats = jdbcTemplate.getExecutionMonitor().getQueryStatistics();
        System.out.println("æŸ¥è¯¢æ€»æ•°: " + queryStats.getTotalQueries());
        System.out.println("æˆåŠŸæŸ¥è¯¢: " + queryStats.getSuccessQueries());
        System.out.println("å¤±è´¥æŸ¥è¯¢: " + queryStats.getFailureQueries());
        System.out.println("å¹³å‡æŸ¥è¯¢æ—¶é—´: " + queryStats.getAverageQueryTime() + "ms");
        
        // è·å–æ›´æ–°ç»Ÿè®¡
        UpdateStatistics updateStats = jdbcTemplate.getExecutionMonitor().getUpdateStatistics();
        System.out.println("æ›´æ–°æ€»æ•°: " + updateStats.getTotalUpdates());
        
        // è·å–æ…¢æŸ¥è¯¢ä¿¡æ¯
        Map<String, SlowQueryInfo> slowQueries = jdbcTemplate.getExecutionMonitor().getSlowQueries();
        slowQueries.forEach((sql, info) -> {
            System.out.println("æ…¢æŸ¥è¯¢SQL: " + sql);
            System.out.println("æœ€å¤§æ‰§è¡Œæ—¶é—´: " + info.getMaxTime() + "ms");
            System.out.println("å‡ºç°æ¬¡æ•°: " + info.getCount());
        });
    }
}
```

### ğŸ¨ æ™ºèƒ½æ˜ å°„

#### è‡ªåŠ¨é©¼å³°è½¬æ¢

```java
// æ•°æ®åº“å­—æ®µï¼šuser_name, email_address, created_time
// Javaå¯¹è±¡å­—æ®µï¼šuserName, emailAddress, createdTime
// è‡ªåŠ¨æ˜ å°„ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®

@Data
public class User {
    private Long id;
    private String userName;      // è‡ªåŠ¨æ˜ å°„ user_name
    private String emailAddress;  // è‡ªåŠ¨æ˜ å°„ email_address  
    private LocalDateTime createdTime; // è‡ªåŠ¨æ˜ å°„ created_time
}

User user = jdbcOperations.queryForObject(
    "SELECT id, user_name, email_address, created_time FROM users WHERE id = :id",
    Map.of("id", 1L),
    User.class  // è‡ªåŠ¨å®Œæˆé©¼å³°è½¬æ¢æ˜ å°„
);
```

#### ç±»å‹å®‰å…¨å‚æ•°

```java
// ä½¿ç”¨TypeSafeParameterSourceç¡®ä¿ç±»å‹å®‰å…¨
TypeSafeParameterSource params = new TypeSafeParameterSource()
    .addValue("id", 1L)                    // Longç±»å‹
    .addValue("username", "john")          // Stringç±»å‹
    .addValue("active", true)              // Booleanç±»å‹
    .addValue("createdTime", LocalDateTime.now()) // LocalDateTimeç±»å‹
    .addValue("score", new BigDecimal("95.5"));   // BigDecimalç±»å‹

User user = jdbcOperations.queryForObject(
    "SELECT * FROM users WHERE id = :id AND username = :username",
    params.getParameterMap(),
    User.class
);
```

## é…ç½®è¯¦è§£

### å®Œæ•´é…ç½®ç¤ºä¾‹

```yaml
slavopolis:
  jdbc:
    # åŸºç¡€é…ç½®
    enabled: true                    # æ˜¯å¦å¯ç”¨å¢å¼ºJDBCåŠŸèƒ½
    default-logging-enabled: true    # é»˜è®¤å¯ç”¨æ—¥å¿—
    default-page-size: 20           # é»˜è®¤åˆ†é¡µå¤§å°
    max-page-size: 1000             # æœ€å¤§åˆ†é¡µå¤§å°
    
    # ç›‘æ§é…ç½®
    monitor:
      enabled: true                 # æ˜¯å¦å¯ç”¨SQLæ‰§è¡Œç›‘æ§
      slow-query-threshold: 1000    # æ…¢æŸ¥è¯¢é˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰
      statistics-enabled: true      # æ˜¯å¦å¯ç”¨ç»Ÿè®¡ä¿¡æ¯æ”¶é›†
      statistics-cleanup-interval: 1h  # ç»Ÿè®¡ä¿¡æ¯æ¸…ç†é—´éš”
      max-statistics-entries: 10000 # æœ€å¤§ç»Ÿè®¡æ¡ç›®æ•°

    # å®‰å…¨é…ç½®
    security:
      # JdbcProperties.Security é…ç½®
      sql-injection-detection-enabled: true  # æ˜¯å¦å¯ç”¨SQLæ³¨å…¥æ£€æµ‹
      parameter-validation-enabled: true     # æ˜¯å¦å¯ç”¨å‚æ•°éªŒè¯
      dangerous-keywords:                    # å±é™©å…³é”®è¯åˆ—è¡¨
        - "DROP"
        - "DELETE"
        - "TRUNCATE"
        - "ALTER"
        - "CREATE"
        - "INSERT"
        - "UPDATE"
        - "GRANT"
        - "REVOKE"
        - "EXEC"
        - "EXECUTE"
        - "UNION"
        - "SCRIPT"
        - "JAVASCRIPT"
        - "VBSCRIPT"
        - "ONLOAD"
        - "ONERROR"
      sensitive-table-control-enabled: false # æ˜¯å¦å¯ç”¨æ•æ„Ÿè¡¨è®¿é—®æ§åˆ¶
      sensitive-tables:                      # æ•æ„Ÿè¡¨ååˆ—è¡¨
        - "user"
        - "password"
        - "credential"
        - "token"
        - "session"
      
      # SqlSecurityConfig ä¸“ç”¨é…ç½®
      enabled: true                          # æ˜¯å¦å¯ç”¨SQLå®‰å…¨æ£€æŸ¥ï¼ˆæ€»å¼€å…³ï¼‰
      sql-injection-detection: true         # æ˜¯å¦å¯ç”¨SQLæ³¨å…¥æ£€æµ‹
      parameter-validation: true             # æ˜¯å¦å¯ç”¨å‚æ•°éªŒè¯
      sensitive-data-masking: true           # æ˜¯å¦å¯ç”¨æ•æ„Ÿä¿¡æ¯æ©ç 
      sensitive-parameter-patterns:          # æ•æ„Ÿå‚æ•°åç§°æ¨¡å¼
        - "password"
        - "pwd"
        - "secret"
        - "token"
        - "key"
        - "auth"
      max-parameter-length: 10000           # æœ€å¤§å‚æ•°å€¼é•¿åº¦
      max-batch-size: 1000                  # æœ€å¤§æ‰¹å¤„ç†å¤§å°
      allow-ddl-operations: false           # æ˜¯å¦å…è®¸DDLæ“ä½œ
      allow-unsafe-operations: false        # æ˜¯å¦å…è®¸æ— WHEREå­å¥çš„UPDATE/DELETE
      max-sql-length: 50000                 # SQLé•¿åº¦é™åˆ¶
      log-security-warnings: true           # æ˜¯å¦è®°å½•å®‰å…¨è­¦å‘Š
        
    # äº‹åŠ¡é…ç½®
    transaction:
      propagation: REQUIRED                  # é»˜è®¤äº‹åŠ¡ä¼ æ’­è¡Œä¸º
      isolation: DEFAULT                     # é»˜è®¤äº‹åŠ¡éš”ç¦»çº§åˆ«
      timeout: 30                           # é»˜è®¤äº‹åŠ¡è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
      read-only: false                      # æ˜¯å¦åªè¯»äº‹åŠ¡
      rollback-for:                         # å›æ»šå¼‚å¸¸ç±»ååˆ—è¡¨
        - "java.lang.Exception"
        
    # æ˜ å°„é…ç½®
    mapping:
      default-strategy: INTELLIGENT          # é»˜è®¤æ˜ å°„ç­–ç•¥
      cache-enabled: true                   # æ˜¯å¦å¯ç”¨æ˜ å°„ç¼“å­˜
      max-cache-entries: 1000               # æ˜ å°„ç¼“å­˜æœ€å¤§æ¡ç›®æ•°
      check-fully-populated: false         # æ˜¯å¦æ£€æŸ¥å®Œæ•´æ˜ å°„
      primitives-defaulted-for-null-value: false  # åŸå§‹ç±»å‹æ˜¯å¦é»˜è®¤ä¸ºnullå€¼
      underscore-to-camel-case: true        # ä¸‹åˆ’çº¿è½¬é©¼å³°æ˜ å°„
```

## æœ€ä½³å®è·µ

### 1. å‚æ•°å‘½åè§„èŒƒ

```java
// âœ… æ¨èï¼šä½¿ç”¨æœ‰æ„ä¹‰çš„å‚æ•°å
Map<String, Object> params = Map.of(
    "userId", 1L,
    "startDate", LocalDate.now().minusDays(30),
    "status", "ACTIVE"
);

// âŒ ä¸æ¨èï¼šä½¿ç”¨æ— æ„ä¹‰çš„å‚æ•°å
Map<String, Object> params = Map.of(
    "p1", 1L,
    "p2", LocalDate.now().minusDays(30),
    "p3", "ACTIVE"
);
```

### 2. SQLè¯­å¥æ ¼å¼åŒ–

```java
// âœ… æ¨èï¼šæ ¼å¼åŒ–SQLè¯­å¥ï¼Œæé«˜å¯è¯»æ€§
String sql = """
    SELECT u.id, u.username, u.email, p.nickname, p.avatar_url
    FROM users u
    LEFT JOIN user_profiles p ON u.id = p.user_id
    WHERE u.status = :status
      AND u.created_time >= :startDate
      AND u.department_id = :departmentId
    ORDER BY u.created_time DESC
    """;

// âŒ ä¸æ¨èï¼šå•è¡Œé•¿SQLè¯­å¥
String sql = "SELECT u.id, u.username, u.email, p.nickname, p.avatar_url FROM users u LEFT JOIN user_profiles p ON u.id = p.user_id WHERE u.status = :status AND u.created_time >= :startDate AND u.department_id = :departmentId ORDER BY u.created_time DESC";
```

### 3. å¼‚å¸¸å¤„ç†

```java
// âœ… æ¨èï¼šé€‚å½“çš„å¼‚å¸¸å¤„ç†
public User findUserById(Long id) {
    try {
        return jdbcOperations.queryForObject(
            "SELECT * FROM users WHERE id = :id",
            Map.of("id", id),
            User.class
        );
    } catch (EmptyResultDataAccessException e) {
        log.debug("User not found with id: {}", id);
        return null;
    } catch (DataAccessException e) {
        log.error("Database error when finding user with id: {}", id, e);
        throw new ServiceException("æŸ¥è¯¢ç”¨æˆ·å¤±è´¥", e);
    }
}
```

### 4. åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–

```java
// âœ… æ¨èï¼šåˆç†çš„åˆ†é¡µå‚æ•°éªŒè¯
public PageResult.PageData<User> findUsers(int pageNum, int pageSize, String status) {
    // å‚æ•°éªŒè¯
    if (pageNum < 1) pageNum = 1;
    if (pageSize < 1 || pageSize > 100) pageSize = 20;
    
    String sql = """
        SELECT id, username, email, status, created_time
        FROM users
        WHERE status = :status
        ORDER BY created_time DESC
        """;
    
    return jdbcOperations.queryForPage(
        sql,
        Map.of("status", status),
        User.class,
        pageNum,
        pageSize
    );
}
```

### 5. æ‰¹å¤„ç†ä¼˜åŒ–

```java
// âœ… æ¨èï¼šåˆç†çš„æ‰¹å¤„ç†å¤§å°
public void batchInsertUsers(List<User> users) {
    if (users.isEmpty()) return;
    
    // åˆ†æ‰¹å¤„ç†ï¼Œé¿å…å†…å­˜æº¢å‡º
    int batchSize = 500;
    for (int i = 0; i < users.size(); i += batchSize) {
        List<User> batch = users.subList(i, Math.min(i + batchSize, users.size()));
        
        Map<String, Object>[] batchParams = batch.stream()
            .map(user -> Map.of(
                "username", user.getUsername(),
                "email", user.getEmail(),
                "status", user.getStatus()
            ))
            .toArray(Map[]::new);
        
        jdbcOperations.batchUpdate(
            "INSERT INTO users (username, email, status) VALUES (:username, :email, :status)",
            batchParams
        );
    }
}
```

## å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•å¤„ç†å¤æ‚çš„ç»“æœé›†æ˜ å°„ï¼Ÿ

**A:** å¯¹äºå¤æ‚çš„ç»“æœé›†ï¼Œå»ºè®®ä½¿ç”¨è‡ªå®šä¹‰RowMapperï¼š

```java
public class UserDetailRowMapper implements RowMapper<UserDetail> {
    @Override
    public UserDetail mapRow(ResultSet rs, int rowNum) throws SQLException {
        return UserDetail.builder()
            .id(rs.getLong("id"))
            .username(rs.getString("username"))
            .email(rs.getString("email"))
            .profile(UserProfile.builder()
                .nickname(rs.getString("nickname"))
                .avatarUrl(rs.getString("avatar_url"))
                .build())
            .department(Department.builder()
                .id(rs.getLong("dept_id"))
                .name(rs.getString("dept_name"))
                .build())
            .build();
    }
}

// ä½¿ç”¨è‡ªå®šä¹‰RowMapper
UserDetail userDetail = jdbcOperations.queryForObject(
    complexJoinSql,
    params,
    new UserDetailRowMapper()
);
```

### Q2: å¦‚ä½•å¤„ç†å¤§ç»“æœé›†æŸ¥è¯¢ï¼Ÿ

**A:** å¯¹äºå¤§ç»“æœé›†ï¼Œå»ºè®®ä½¿ç”¨åˆ†é¡µæŸ¥è¯¢æˆ–æµå¼å¤„ç†ï¼š

```java
// æ–¹æ¡ˆ1ï¼šåˆ†é¡µå¤„ç†
public void processAllUsers() {
    int pageNum = 1;
    int pageSize = 1000;
    PageResult.PageData<User> page;
    
    do {
        page = jdbcOperations.queryForPage(
            "SELECT * FROM users ORDER BY id",
            Collections.emptyMap(),
            User.class,
            pageNum,
            pageSize
        );
        
        // å¤„ç†å½“å‰é¡µæ•°æ®
        processUserBatch(page.getRecords());
        pageNum++;
        
    } while (!page.isLast());
}

// æ–¹æ¡ˆ2ï¼šä½¿ç”¨LIMITåˆ†æ‰¹æŸ¥è¯¢
public void processUsersByBatch() {
    Long lastId = 0L;
    int batchSize = 1000;
    List<User> batch;
    
    do {
        batch = jdbcOperations.queryForList(
            "SELECT * FROM users WHERE id > :lastId ORDER BY id LIMIT :limit",
            Map.of("lastId", lastId, "limit", batchSize),
            User.class
        );
        
        if (!batch.isEmpty()) {
            processUserBatch(batch);
            lastId = batch.get(batch.size() - 1).getId();
        }
        
    } while (batch.size() == batchSize);
}
```

### Q3: å¦‚ä½•ä¼˜åŒ–æ…¢æŸ¥è¯¢ï¼Ÿ

**A:** åˆ©ç”¨å†…ç½®çš„ç›‘æ§åŠŸèƒ½è¯†åˆ«å’Œä¼˜åŒ–æ…¢æŸ¥è¯¢ï¼š

```java
@Component
public class DatabaseOptimizationService {
    
    private final EnhancedJdbcTemplate jdbcTemplate;
    
    @Scheduled(fixedRate = 300000) // æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    public void checkSlowQueries() {
        Map<String, SlowQueryInfo> slowQueries = 
            jdbcTemplate.getExecutionMonitor().getSlowQueries();
        
        slowQueries.forEach((sql, info) -> {
            if (info.getMaxTime() > 5000) { // è¶…è¿‡5ç§’çš„æŸ¥è¯¢
                log.warn("å‘ç°è¶…æ…¢æŸ¥è¯¢ - SQL: {}, æœ€å¤§æ‰§è¡Œæ—¶é—´: {}ms, å‡ºç°æ¬¡æ•°: {}", 
                    sql, info.getMaxTime(), info.getCount());
                
                // å¯ä»¥å‘é€å‘Šè­¦æˆ–è®°å½•åˆ°ç›‘æ§ç³»ç»Ÿ
                alertSlowQuery(sql, info);
            }
        });
    }
}
```

## æ€»ç»“

Slavopolis-JDBC ä¸ºä¼ä¸šçº§Javaåº”ç”¨æä¾›äº†ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ã€å®‰å…¨å¯é çš„æ•°æ®è®¿é—®è§£å†³æ–¹æ¡ˆã€‚é€šè¿‡æœ¬æŒ‡å—ï¼Œæ‚¨å·²ç»æŒæ¡äº†ï¼š

- âœ… å¿«é€Ÿé›†æˆå’ŒåŸºç¡€é…ç½®
- âœ… å„ç§æŸ¥è¯¢å’Œæ›´æ–°æ“ä½œçš„ä½¿ç”¨æ–¹æ³•
- âœ… äº‹åŠ¡ç®¡ç†å’Œæ‰¹å¤„ç†æ“ä½œ
- âœ… å®‰å…¨é˜²æŠ¤å’Œç›‘æ§åŠŸèƒ½
- âœ… é«˜çº§ç‰¹æ€§å’Œæœ€ä½³å®è·µ

### ä¸‹ä¸€æ­¥å»ºè®®

1. **æ·±å…¥å­¦ä¹ **ï¼šé˜…è¯»ã€ŠSlavopolis-JDBC æŠ€æœ¯è§£æã€‹äº†è§£åº•å±‚å®ç°åŸç†
2. **å®è·µåº”ç”¨**ï¼šåœ¨å®é™…é¡¹ç›®ä¸­åº”ç”¨æ‰€å­¦çŸ¥è¯†
3. **æ€§èƒ½è°ƒä¼˜**ï¼šæ ¹æ®ç›‘æ§æ•°æ®ä¼˜åŒ–SQLå’Œé…ç½®
4. **ç¤¾åŒºå‚ä¸**ï¼šå…³æ³¨é¡¹ç›®æ›´æ–°ï¼Œå‚ä¸ç¤¾åŒºè®¨è®º

### æŠ€æœ¯æ”¯æŒ

- ğŸ“š **æ–‡æ¡£ä¸­å¿ƒ**ï¼š[https://docs.slavopolis.club/jdbc](https://docs.slavopolis.club/jdbc)
- ğŸ› **é—®é¢˜åé¦ˆ**ï¼š[https://github.com/slavopolis/slavopolis-boot/issues](https://github.com/slavopolis/slavopolis-boot/issues)
- ğŸ’¬ **æŠ€æœ¯äº¤æµ**ï¼šåŠ å…¥SlavopolisæŠ€æœ¯äº¤æµç¾¤

---

*Slavopolis-JDBC - è®©æ•°æ®è®¿é—®æ›´ç®€å•ã€æ›´å®‰å…¨ã€æ›´é«˜æ•ˆï¼* 
